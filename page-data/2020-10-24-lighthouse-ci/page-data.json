{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-10-24-lighthouse-ci/","result":{"data":{"site":{"siteMetadata":{"title":"kohsweblog","author":"koh110"}},"markdownRemark":{"id":"bd708223-14e2-5dfd-9fc3-ff67f35661be","excerpt":"Core Web Vitals とは 最近のフロントエンド周辺では Google が提唱した Web Vitals と呼ばれる指標が非常に注目されています。 これは Web…","html":"<h1 id=\"core-web-vitals-とは\" style=\"position:relative;\"><a href=\"#core-web-vitals-%E3%81%A8%E3%81%AF\" aria-label=\"core web vitals とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core Web Vitals とは</h1>\n<p>最近のフロントエンド周辺では Google が提唱した Web Vitals と呼ばれる指標が非常に注目されています。</p>\n<p>これは Web で多くのユーザーが快適なユーザー体験を得るために、こういったポイントに特に気を使いましょう、というものを数値化したものです。</p>\n<p>この中でも特に重要と定められている “LCP (Largest Contentful Paint)”, “FID (First Input Delay)”, “CLS (Cumulative Layout Shift)” の 3 つは Core Web Vitals と呼ばれています。</p>\n<p>それぞれの観点を簡単に説明すると次のようになります。</p>\n<ul>\n<li>LCP: 重要な要素がどれだけ早く読み込まれたか</li>\n<li>FID: 最初の入力ができるまでにどれくらいかかったか</li>\n<li>CLS: がくっとレイアウトが変わることがないか</li>\n</ul>\n<p>Ref: <a href=\"https://developers-jp.googleblog.com/2020/05/web-vitals.html\">Web Vitals の概要: サイトの健全性を示す重要指標</a></p>\n<p>例えば製品を説明するページのヒーローイメージのサイズがとても大きく、読み込みに時間がかかったらユーザーはがっかりして離脱してしまうかもしれません。それを表した指標が LCP だと思ってください。</p>\n<p>例えば JavaScript を使ったとてもリッチな表現で見た目のよいシステムを作ったとします。しかし JavaScript を処理し終わるまで検索バーが使えなかったらとても使いにくいシステムと思われてしまうでしょう。FID はいかにシステムの機能を最速でユーザーに届けるという指標です。</p>\n<p>実際にスマホなどでページを読み込んでいる最中に、突然広告が読み込まれて変なところをタップしてしまったという経験はないでしょうか。そのイライラをユーザーに与えてしまっていないかを数値化した指標が CLS です。</p>\n<p>もちろんこれらのスコアが全てではないですが、これらのスコアを上げることができればユーザーにとって快適に近づくというのはイメージしやすいのではないでしょうか。</p>\n<p>また Google は Chrome 上でバッヂをつけることで、高速なサイトと低速なサイトを見分けられるようにし、高速なサイトを優遇すると述べています。（Android 版の Chrome では chrome://flags から <code class=\"language-text\">Context menu performance info and remote hint fetching</code> フラグをオンにすることで、すでにこの機能が利用可能です。）</p>\n<p>Ref: <a href=\"https://developers-jp.googleblog.com/2019/12/blog-post_10.html\">さらに高速なウェブへの移行に向けて</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 320px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d71dba3a07effa9d0fa398a9bab7a76e/cb69c/chrome-badge.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGgABAAIDAQAAAAAAAAAAAAAAAAQFAQIDBv/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGNvbTDyiYss5tP3lhOYqchqD//xAAeEAACAgICAwAAAAAAAAAAAAACAwABEjMEFBETIf/aAAgBAQABBQIU2weuyF4EuLpqP38XTUd9cp9LDt1LLI8ymZT2FP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BX//EACIQAAECBgEFAAAAAAAAAAAAAAABAhAREiExMnEDM1GBof/aAAgBAQAGPwKpvSmh2fpS5l0E5g+yZPcH8lMjRRzvKmTJsp//xAAfEAACAgEEAwAAAAAAAAAAAAAAAREhMVFhcYEQQaH/2gAIAQEAAT8hXZxuhKx8B3oFDRGpewi75FeSEEsajI6CBNTu25UFVTcoqCLoN+XK+NfCf//aAAwDAQACAAMAAAAQOD48c8//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREg/9oACAEDAQE/ECjeP//EABcRAAMBAAAAAAAAAAAAAAAAAAABESD/2gAIAQIBAT8QIs//xAAhEAEAAgEEAgMBAAAAAAAAAAABABEhMUFRYbHBcZHR8f/aAAgBAQABPxAtjUE2Pll5bnWv1l795A1GUJMKUVmF0A4Nkin7hrOCAcUHDz3NRzp16iNWekQCqzDc3vEK2BWJMk8SkUwGfqFT54eWSf1J/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Chrome SpeedBadge\"\n        title=\"Chrome SpeedBadge\"\n        src=\"/static/d71dba3a07effa9d0fa398a9bab7a76e/cb69c/chrome-badge.jpg\"\n        srcset=\"/static/d71dba3a07effa9d0fa398a9bab7a76e/a80bd/chrome-badge.jpg 148w,\n/static/d71dba3a07effa9d0fa398a9bab7a76e/1c91a/chrome-badge.jpg 295w,\n/static/d71dba3a07effa9d0fa398a9bab7a76e/cb69c/chrome-badge.jpg 320w\"\n        sizes=\"(max-width: 320px) 100vw, 320px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"core-web-vitals-の計測\" style=\"position:relative;\"><a href=\"#core-web-vitals-%E3%81%AE%E8%A8%88%E6%B8%AC\" aria-label=\"core web vitals の計測 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core Web Vitals の計測</h1>\n<p>言葉にしてしまえばどの指標も当たり前のように聞こえてしまう話ですが、これら全てをシステムを作っている段階で気にしながら開発するのは非常に難易度が高いことです。そこで、これらのスコアを特定のタイミングで可視化することが重要になります。</p>\n<p>そのためにいくつかのツールが提供されています。</p>\n<h2 id=\"crux-searchconsole\" style=\"position:relative;\"><a href=\"#crux-searchconsole\" aria-label=\"crux searchconsole permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CrUX, SearchConsole</h2>\n<p>先程の指標は実際に（Chrome を利用している）ユーザーがどのような影響を受けたかを集めたデータ（フィールドデータ）によって計測されます。</p>\n<p>これらのデータを集計、サマライズしたものを Chrome User Experience Report (CrUX) のダッシュボードで参照することができます。</p>\n<p>Ref:</p>\n<ul>\n<li><a href=\"https://developers.google.com/web/tools/chrome-user-experience-report\">chrome-user-experience-report</a></li>\n<li><a href=\"https://developers.google.com/web/updates/2018/08/chrome-ux-report-dashboard\">CrUX Dashboard</a></li>\n</ul>\n<p>また、SearchConsole を利用している場合は「ウェブに関する主な指標」から同様のデータを参照することが可能です。</p>\n<p>しかしこれらのツールはフィールドデータを利用している事で弱点も生まれます。そう、例えばこのブログのように十分な匿名データが集まらない程度の PV しかないサイトでは、悲しいことにデータ量が少なすぎて表示できません。</p>\n<p>とはいえ悲しんでばかりもいられないので他の方法でスコアを計測します。</p>\n<h2 id=\"pagespeed-insights-lighthouse\" style=\"position:relative;\"><a href=\"#pagespeed-insights-lighthouse\" aria-label=\"pagespeed insights lighthouse permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PageSpeed Insights, Lighthouse</h2>\n<p>では十分フィールドデータが集められない環境ではどうやってスコアを計測するのか。ここで登場するのが PageSpeed Insights や Lighthouse です。</p>\n<p>これらのツールはフィールドデータではなくラボデータ、つまり実行したタイミングでそのツールが計測した値を元にスコアリングを行います。</p>\n<p>昔は Chrome の拡張として提供されていた Lighthouse ですが、最近は Chrome の開発者ツールにバンドルされています。</p>\n<p>PageSpeed Insights は Lighthouse を Web 上で実行できるプラットフォームと思って貰えれば大丈夫です。PageSpeed Insights では十分なフィールドデータがある場合、フィールドデータとラボデータの両方が同時に確認可能です。</p>\n<p>PageSpeed Insights はインターネット上でアクセスできる URL がなければ利用できませんが、Lighthouse はブラウザにバンドルされているため、インターネットから隔離された社内環境等でも計測が可能です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d815d169c390ff6bc0611a06622a8b63/e5166/lighthouse.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 120.94594594594594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAYABQDASIAAhEBAxEB/8QAGQABAQADAQAAAAAAAAAAAAAAAAMBAgQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAfPjeCasl7pBAH//xAAbEAACAgMBAAAAAAAAAAAAAAACAwEQABMjM//aAAgBAQABBQJ3vT47UxhC3ezCKTn/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAeEAACAAYDAAAAAAAAAAAAAAAAAQIDEBEicjEyQf/aAAgBAQAGPwKPY9pM2rMSdsmdi8XJ/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAERQSExUWFxgfD/2gAIAQEAAT8h5uoxeHZ6yisQ4sZHzbR9kiY0j//aAAwDAQACAAMAAAAQFwgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRABAQEBAAIDAQAAAAAAAAAAAREAITFhQVHB8P/aAAgBAQABPxB8VBxjPnS+ksBn6ORYTOoe8sKUeOYI9J60o6kh6uQeX/X1ktEBZPG//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse\"\n        title=\"Lighthouse\"\n        src=\"/static/d815d169c390ff6bc0611a06622a8b63/1c72d/lighthouse.jpg\"\n        srcset=\"/static/d815d169c390ff6bc0611a06622a8b63/a80bd/lighthouse.jpg 148w,\n/static/d815d169c390ff6bc0611a06622a8b63/1c91a/lighthouse.jpg 295w,\n/static/d815d169c390ff6bc0611a06622a8b63/1c72d/lighthouse.jpg 590w,\n/static/d815d169c390ff6bc0611a06622a8b63/a8a14/lighthouse.jpg 885w,\n/static/d815d169c390ff6bc0611a06622a8b63/fbd2c/lighthouse.jpg 1180w,\n/static/d815d169c390ff6bc0611a06622a8b63/e5166/lighthouse.jpg 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Lighthouse は各指標で具体的にどれくらいの時間がかかったか、それから計算されるスコアはいくつかなどが確認可能です。さらにその結果から具体的にこの部分を直しましょうというアドバイスまでしてくれます。</p>\n<p>例えばページの中で大きな画像が読み込まれていれば「この画像のフォーマットを変えたり、サイズを縮小しましょう」となったり、利用していない JavaScript が読み込まれていれば「利用していない JavaScript を削除しましょう」と具体的なファイル名を教えてくれる、といった具合に直すべき箇所をあげてくれます。</p>\n<p>実際にスコアを上げる際には Lighthouse に何度もお世話になる事になるでしょう。</p>\n<p>Ref:</p>\n<ul>\n<li><a href=\"https://developers.google.com/speed/pagespeed/insights/\">PageSpeed Insights</a></li>\n<li><a href=\"https://developers.google.com/web/tools/lighthouse/\">Lighthouse</a></li>\n</ul>\n<p>ラボデータはデータ量が十分に集まっていない状態でもスコアを算出することができることがメリットです。逆にいうと計測環境のネットワークや CPU にスコアが左右されやすいということに考慮が必要です。</p>\n<p>また、これらのスコアは一度測ればいいものではなく、常に計測を続けて追加した機能などでスコアが低下していないか、などスコアの推移を見ることで効果を発揮するものです。そのためにも一定のタイミング/性能で計測を続けたくなります。</p>\n<p>つまり CI に組み込んだり、cron で回したくなるのが自然な発想でしょう。それを実現するために Lighthouse をラップした Lighthouse CI というツールが提供されています。</p>\n<h1 id=\"lighthouse-ci-の構築\" style=\"position:relative;\"><a href=\"#lighthouse-ci-%E3%81%AE%E6%A7%8B%E7%AF%89\" aria-label=\"lighthouse ci の構築 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lighthouse CI の構築</h1>\n<p>Ligthouse CI とは Lighthouse を CI のステップに組み込むことができるツールです。データを貯め込み可視化する server と、計測を行って server に送信する cli の 2 つのパッケージから構成されています。</p>\n<p><a href=\"https://github.com/GoogleChrome/lighthouse-ci\">https://github.com/GoogleChrome/lighthouse-ci</a></p>\n<p>実際にどのようにして Lighthouse CI を構築・運用していくのかを、Ubuntu 上で実行しながら解説していきます。</p>\n<h2 id=\"lighthouse-ci-server-の構築\" style=\"position:relative;\"><a href=\"#lighthouse-ci-server-%E3%81%AE%E6%A7%8B%E7%AF%89\" aria-label=\"lighthouse ci server の構築 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lighthouse CI Server の構築</h2>\n<p>Server の構築方法を簡単にまとめると次の 3 ステップになります。公式の手順は<a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/server.md\">こちら</a>です。</p>\n<ul>\n<li>Node.js のインストール</li>\n<li>MySQL のインストール</li>\n<li>Server アプリケーションの作成</li>\n</ul>\n<p>Lighthouse は Node.js で動くので Node.js を最初にインストールしてください。自分はさくっとインストールする時は次のようなスクリプトを使って構築することが多いです。</p>\n<p>Ref: <a href=\"https://github.com/koh110/node-install/blob/master/insall.sh\">Ndoe.js のインストール</a></p>\n<p>次は MySQL のインストールです。Lighthouse CI Server は MySQL の他に SQLite や PostgreSQL でも動作します。今回は自分が使い慣れている MySQL を選択しました。\n内部的には <a href=\"https://github.com/sequelize/sequelize\">Sequelize</a> を利用しているようです。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> mysql-server mysql-client\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> mysql status\n$ <span class=\"token function\">sudo</span> mysql <span class=\"token parameter variable\">-u</span> root\n\n<span class=\"token comment\"># password は適切な文字列を利用してください</span>\nmysql<span class=\"token operator\">></span> CREATE <span class=\"token environment constant\">USER</span> <span class=\"token string\">'lighthouseuser'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'password'</span><span class=\"token punctuation\">;</span>\nmysql<span class=\"token operator\">></span> GRANT ALL ON lighthouse.* TO lighthouseuser IDENTIFIED BY <span class=\"token string\">'password'</span><span class=\"token punctuation\">;</span>\nmysql<span class=\"token operator\">></span> CREATE DATABASE lighthouse<span class=\"token punctuation\">;</span></code></pre></div>\n<p>MySQL を使って運用している場合、計測結果のアップロード時に Server 側にエラーが出ることがあります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">SequelizeDatabaseError: Incorrect string value: <span class=\"token string\">'...'</span> <span class=\"token keyword\">for</span> <span class=\"token function\">column</span> <span class=\"token string\">'lhr'</span> at row <span class=\"token number\">1</span></code></pre></div>\n<p>MySQL のエンコーディングが <code class=\"language-text\">utf8</code> の場合サロゲートペア文字が扱えないため、MySQL 側の設定を <code class=\"language-text\">utf8mb4</code> に変える必要があるようです。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">\"chara%\"</span><span class=\"token punctuation\">;</span>\n+--------------------------+----------------------------+\n<span class=\"token operator\">|</span> Variable_name            <span class=\"token operator\">|</span> Value                      <span class=\"token operator\">|</span>\n+--------------------------+----------------------------+\n<span class=\"token operator\">|</span> character_set_client     <span class=\"token operator\">|</span> utf8                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_connection <span class=\"token operator\">|</span> utf8                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_database   <span class=\"token operator\">|</span> latin1                     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_filesystem <span class=\"token operator\">|</span> binary                     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_results    <span class=\"token operator\">|</span> utf8                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_server     <span class=\"token operator\">|</span> latin1                     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_system     <span class=\"token operator\">|</span> utf8                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_sets_dir       <span class=\"token operator\">|</span> /usr/share/mysql/charsets/ <span class=\"token operator\">|</span>\n+--------------------------+----------------------------+\n<span class=\"token number\">8</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">/etc/mysql/my.cnf</code> に次の設定を追加しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[mysql]\ndefault-character-set=utf8mb4\n\n[mysqld]\ncharacter-set-server=utf8mb4</code></pre></div>\n<p>上記の設定を追加して MySQL サーバーを再起動すると文字コードが変わっていることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">\"chara%\"</span><span class=\"token punctuation\">;</span>\n+--------------------------+----------------------------+\n<span class=\"token operator\">|</span> Variable_name            <span class=\"token operator\">|</span> Value                      <span class=\"token operator\">|</span>\n+--------------------------+----------------------------+\n<span class=\"token operator\">|</span> character_set_client     <span class=\"token operator\">|</span> utf8mb4                    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_connection <span class=\"token operator\">|</span> utf8mb4                    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_database   <span class=\"token operator\">|</span> utf8mb4                    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_filesystem <span class=\"token operator\">|</span> binary                     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_results    <span class=\"token operator\">|</span> utf8mb4                    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_server     <span class=\"token operator\">|</span> utf8mb4                    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_set_system     <span class=\"token operator\">|</span> utf8                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> character_sets_dir       <span class=\"token operator\">|</span> /usr/share/mysql/charsets/ <span class=\"token operator\">|</span>\n+--------------------------+----------------------------+\n<span class=\"token number\">8</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>最後にアプリケーションの作成を行います。とは言っても config ファイルを用意して cli から起動するだけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">cd</span> lighthouse-ci-server\n$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"{ <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>private<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: true }\"</span> <span class=\"token operator\">></span> package.json\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-D</span> <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-D</span> @lhci/cli @lhci/server mysql2\n$ <span class=\"token function\">touch</span> lighthouserc.js\n\n$ tree <span class=\"token parameter variable\">-L</span> <span class=\"token number\">1</span>\n<span class=\"token builtin class-name\">.</span>\n├── lighthouserc.js\n├── node_modules\n├── package.json\n└── package-lock.json\n\n<span class=\"token number\">1</span> directory, <span class=\"token number\">3</span> files</code></pre></div>\n<p>最初はちょっとわかりにくいのですが、Server も CLI も同じ <code class=\"language-text\">lhci</code> コマンドを使って起動できます。</p>\n<p>サーバーの config 設定は<a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/configuration.md#server\">こちら</a>を参考にします。</p>\n<p><code class=\"language-text\">lhci</code> は内部的に <code class=\"language-text\">yags</code> に依存しているので、オプションでそれぞれの値を設定することもできます。また、モジュールを読み込んで普通のアプリケーションサーバーのように Node.js のスクリプトで起動することもできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@lhci/server'</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Starting server...'</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">port</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">storage</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">storageMethod</span><span class=\"token operator\">:</span> <span class=\"token string\">'sql'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">sqlDialect</span><span class=\"token operator\">:</span> <span class=\"token string\">'sqlite'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">sqlDatabasePath</span><span class=\"token operator\">:</span> <span class=\"token string\">'/path/to/db.sql'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> port <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'LHCI listening on port'</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Ref:</p>\n<p><a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/server.md#general\">Server Docs</a>\n<a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/packages/cli/src/cli.js\">cli.js</a></p>\n<p>サーバーの設定に必要なパラメーターはドキュメントもありますが型定義が提供されているので、ここを参照したほうがわかりやすいと思います。</p>\n<p><a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/types/server.d.ts#L178-L197\">server.d.ts</a></p>\n<p>lighthouserc.js の中身は次のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> sqlConnectionUrl <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mysql://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MYSQL_USER</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MYSQL_PASSWORD</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@localhost/lighthouse</span><span class=\"token template-punctuation string\">`</span></span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">ci</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">server</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">port</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">storage</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">storageMethod</span><span class=\"token operator\">:</span> <span class=\"token string\">'sql'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">sqlDialect</span><span class=\"token operator\">:</span> <span class=\"token string\">'mysql'</span><span class=\"token punctuation\">,</span>\n        sqlConnectionUrl\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>設定ファイルを配置したらサーバーを起動してブラウザの表示を確認してみましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ PORT=3000 MYSQL_USER=lighthouseuser MYSQL_PASSWORD=password ./node_modules/.bin/lhci server --config=./lighthouserc.js</code></pre></div>\n<p>ブラウザで開いてみると初期画面として次のような画面が表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64c645b6f1d7e5be128a069d8e4c946c/c08c5/lighthouse-ci-server.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAQAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2pBmP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAMBAAMAAAAAAAAAAAAAAAABEUEhMWH/2gAIAQEAAT8h5emUVMpe/BI//9oADAMBAAIAAwAAABDLL//EABURAQEAAAAAAAAAAAAAAAAAAAAh/9oACAEDAQE/EEf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAACAgIDAAAAAAAAAAAAAAABEQAhMWFBUXH/2gAIAQEAAT8QDEEe4QcmgzKCmbi5Eg1CgNUlezMOjP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse CI Server\"\n        title=\"Lighthouse CI Server\"\n        src=\"/static/64c645b6f1d7e5be128a069d8e4c946c/1c72d/lighthouse-ci-server.jpg\"\n        srcset=\"/static/64c645b6f1d7e5be128a069d8e4c946c/a80bd/lighthouse-ci-server.jpg 148w,\n/static/64c645b6f1d7e5be128a069d8e4c946c/1c91a/lighthouse-ci-server.jpg 295w,\n/static/64c645b6f1d7e5be128a069d8e4c946c/1c72d/lighthouse-ci-server.jpg 590w,\n/static/64c645b6f1d7e5be128a069d8e4c946c/c08c5/lighthouse-ci-server.jpg 640w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>MySQL 側を確認してみると必要なテーブルが自動で生成されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> use lighthouse<span class=\"token punctuation\">;</span>\nmysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span>\n+----------------------+\n<span class=\"token operator\">|</span> Tables_in_lighthouse <span class=\"token operator\">|</span>\n+----------------------+\n<span class=\"token operator\">|</span> SequelizeMeta        <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> builds               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> projects             <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> runs                 <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> statistics           <span class=\"token operator\">|</span>\n+----------------------+\n<span class=\"token number\">5</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>サーバーの動作を確認したらデーモン化します。自分はプライベートでさくっとやる時には systemd をよく使います。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Unit]\nDescription=lighthouse ci server\n\n[Service]\nType=simple\nEnvironment=PORT=3000\nEnvironment=MYSQL_USER=lighthouseuser\nEnvironment=MYSQL_PASSWORD=password\nWorkingDirectory=/var/lighthouse/lighthouse-server\nExecStart=/var/lighthouse/lighthouse-serve/rnode_modules/.bin/lhcilhci server --config=/var/lighthouse/lighthouse-server/lighthouserc.js\nUser=root\nGroup=root\nRestart=always\nLimitNOFILE=65535\nTimeoutStopSec=60\n\n[Install]\nWantedBy=multi-user.target</code></pre></div>\n<p>次は CLI で実際にスコアを計測して Server に登録してみます。</p>\n<h2 id=\"lighthouse-ci\" style=\"position:relative;\"><a href=\"#lighthouse-ci\" aria-label=\"lighthouse ci permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lighthouse CI</h2>\n<p>実際に CI がデータを Server に登録するまでには 3 ステップの処理を行います。</p>\n<ul>\n<li>collect: 実際にサイトの計測を行うステップ</li>\n<li>assert: スコアが特定値より低い時にエラーを起こすステップ</li>\n<li>upload: 結果を Server に登録するステップ</li>\n</ul>\n<p>この 3 ステップをまとめて autorun として実行することもできます。\nもともと Lighthouse CI は GitHub Actions や Circle CI など CI に組み込むことを想定して作られています。</p>\n<p>今回はコミットごとの計測ではなく、定点観測を行う環境を構築するため assert ステップは飛ばして実行します。</p>\n<p>ともあれ、まずは CLI を使えるようにしないことには始まらないのでグローバルにインストールしてパスを通します。</p>\n<p>記事執筆時点での最新バージョンは 0.5.1 です。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># サーバーにインストールされている lhci のバージョンを調べる</span>\n$ <span class=\"token function\">curl</span> https://your-lhci-server.example.com/version\n\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> @lhci/cli@latest\n$ lhci <span class=\"token parameter variable\">--version</span>\n<span class=\"token number\">0.5</span>.1</code></pre></div>\n<p>Lighthouse CI はプロジェクトという単位で複数の URL を管理することができます。</p>\n<p>なので計測をする前に、まず最初はプロジェクトの作成から入ります。<code class=\"language-text\">lhci wizard</code> コマンドを叩くと対話形式でプロジェクトの作成ができます。\n<code class=\"language-text\">lhci wizard</code> の実行が完了すると Server にプロジェクトを登録し build token と admin token を発行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci wizard\n? Which wizard <span class=\"token keyword\">do</span> you want to run? new-project\n? What is the URL of your LHCI server? http://localhost:3000\n? What would you like to name the project? kohsweb\n? Where is the project<span class=\"token string\">'s code hosted? https://github.com/koh110/lighouse-kohsweb\n? What branch is considered the repo'</span>s trunk or main branch? master\nCreated project kohsweb <span class=\"token punctuation\">(</span>9498cd1d-02e5-4418-a974-bda42c4513e0<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\nUse build token xxxxx-xxxx-xxxx-xxxx-xxxxxxxxx to <span class=\"token function\">add</span> data.\nUse admin token xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx to manage data. KEEP THIS SECRET<span class=\"token operator\">!</span></code></pre></div>\n<p>Server の UI を見に行くとプロジェクトが登録されています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d0402fd632ae592189a1084c3c977202/c08c5/lighthouse-ci-server-2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAAB/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABcwbDaj//xAAWEAADAAAAAAAAAAAAAAAAAAAEEDT/2gAIAQEAAQUCEmQky//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAAAIQ/9oACAEBAAY/AjTf/8QAHBAAAgEFAQAAAAAAAAAAAAAAAAFREBFBYbGh/9oACAEBAAE/IZOH2iueN9J0JH//2gAMAwEAAgADAAAAEGvv/8QAFREBAQAAAAAAAAAAAAAAAAAAACH/2gAIAQMBAT8QR//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQADAQADAQAAAAAAAAAAAAEAETEhUXGxwf/aAAgBAQABPxBJmP0TrbjnWaVbC23n1RaHXKc9zY8M/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse CI Server\"\n        title=\"Lighthouse CI Server\"\n        src=\"/static/d0402fd632ae592189a1084c3c977202/1c72d/lighthouse-ci-server-2.jpg\"\n        srcset=\"/static/d0402fd632ae592189a1084c3c977202/a80bd/lighthouse-ci-server-2.jpg 148w,\n/static/d0402fd632ae592189a1084c3c977202/1c91a/lighthouse-ci-server-2.jpg 295w,\n/static/d0402fd632ae592189a1084c3c977202/1c72d/lighthouse-ci-server-2.jpg 590w,\n/static/d0402fd632ae592189a1084c3c977202/c08c5/lighthouse-ci-server-2.jpg 640w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>先程発行された admin token を使って画面上から、プロジェクトの設定の変更や削除が可能です。</p>\n<p>build token は upload ステップで Server にデータを登録するために必要となります。</p>\n<h3 id=\"collect\" style=\"position:relative;\"><a href=\"#collect\" aria-label=\"collect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>collect</h3>\n<p>まずは Server と同様に lighthouserc.js を用意します。設定項目は CLI のオプションからも渡すことはできます。複数のプロジェクトで共通する設定などをコンフィグで管理し、変動する値を CLI のオプションで渡すのがよいのではないかと思います。</p>\n<p>ひとまずサンプルとして <code class=\"language-text\">numberOfRuns</code> を設定してみましょう。Lighthouse は通信状況やアプリケーションの状態によってもスコアが変わってくるので、デフォルトで 3 回繰り返して計測します。それを 5 回実行してコンフィグファイルの挙動を確認してみます。</p>\n<p>Ref: <a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/configuration.md#collect\">collect の設定項目</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">ci</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">collect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">numberOfRuns</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>うまく動作すると 5 回実行されることが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js\nRunning Lighthouse <span class=\"token number\">5</span> time<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> on https://blog.koh.dev\nRun <span class=\"token comment\">#1...done.</span>\nRun <span class=\"token comment\">#2...done.</span>\nRun <span class=\"token comment\">#3...done.</span>\nRun <span class=\"token comment\">#4...done.</span>\nRun <span class=\"token comment\">#5...done.</span>\nDone running Lighthouse<span class=\"token operator\">!</span></code></pre></div>\n<p>GUI 環境であれば計測した結果をブラウザで確認することが可能です。計測結果は <code class=\"language-text\">.lighthouseci/</code> ディレクトリに保存されていて、ここの html を開いてくれます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci <span class=\"token function\">open</span>\nOpening median report <span class=\"token keyword\">for</span> https://blog.koh.dev/<span class=\"token punctuation\">..</span>.\nDone<span class=\"token operator\">!</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9036b45222b3cf34386939f113cf89b3/e5166/lighthouse-ci.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB34oUf//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABYQAQEBAAAAAAAAAAAAAAAAAAEQAP/aAAgBAQABPyHEb//aAAwDAQACAAMAAAAQIw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEAAgIDAAAAAAAAAAAAAAABABEQIUFRYf/aAAgBAQABPxBDQwF+33KjqoHOP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse CI\"\n        title=\"Lighthouse CI\"\n        src=\"/static/9036b45222b3cf34386939f113cf89b3/1c72d/lighthouse-ci.jpg\"\n        srcset=\"/static/9036b45222b3cf34386939f113cf89b3/a80bd/lighthouse-ci.jpg 148w,\n/static/9036b45222b3cf34386939f113cf89b3/1c91a/lighthouse-ci.jpg 295w,\n/static/9036b45222b3cf34386939f113cf89b3/1c72d/lighthouse-ci.jpg 590w,\n/static/9036b45222b3cf34386939f113cf89b3/a8a14/lighthouse-ci.jpg 885w,\n/static/9036b45222b3cf34386939f113cf89b3/fbd2c/lighthouse-ci.jpg 1180w,\n/static/9036b45222b3cf34386939f113cf89b3/e5166/lighthouse-ci.jpg 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>GUI 環境でない場合は Chrome が実行できなくて失敗することがあります。Chrome をインストールしてもよいですが、puppeteer モジュールの中にバンドルされている Chrome を使うのが楽だと思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> i puppeteer</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> puppeteer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'puppeteer'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">ci</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">collect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">chromePath</span><span class=\"token operator\">:</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">executablePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">numberOfRuns</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>url オプションは複数回指定することで複数同時に計測できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://koh.dev <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js</code></pre></div>\n<p>これで計測は完了、としてしまってもいいですが実は Lighthouse CI はデフォルト値がスマホに合わせてあるため、このままではスマホ環境しか計測できません。</p>\n<p>Lighthouse はスマホ環境を計測する場合は CPU やネットワークを擬似的に遅くしてスマホでの動作をエミュレートしています。</p>\n<p>では具体的にどこのオプションを切り替えればいいかというと <a href=\"https://github.com/GoogleChrome/lighthouse-ci/blob/master/docs/configuration.md#settings\">settings オプジェクト</a>の <code class=\"language-text\">emulatedFormFactor</code> を修正することで変更が可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--settings.emulatedFormFactor</span><span class=\"token operator\">=</span>desktop <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js</code></pre></div>\n<p>settings オブジェクトが具体的にどんなオプションを受け付けるのかは Lighthouse の型定義ファイルをみてくださいということになっています。この辺はちょっとドキュメントが簡素で迷うことがありますね。</p>\n<p>Ref: <a href=\"https://github.com/GoogleChrome/lighthouse/blob/575e29b8b6634bfb280bc820efea6795f3dd9017/types/externs.d.ts#L141-L186\">settings</a></p>\n<p>さあこれでデスクトップ環境も計測できるようになった、と思うと実はまだこれだけでは Chrome に内蔵されている Lighthouse とはスコアに差が出ます。（ネットワークの状況や計測環境のスペックによってもスコアは変わるのでスコアが違ったからといって一概に間違ってるとは言えませんが）</p>\n<p><code class=\"language-text\">emulatedFormFactor</code> は Lighthouse の UserAgent しか変更しないので、ネットワークや CPU のエミュレートはスマホ向けの値のままなので、Chrome 内蔵の Lighthouse の Desktop を計測した時と同じような値を取得するためにはその値に変更する必要があります。</p>\n<p>具体的にそれらの値がどこで管理されているかを探してみると <a href=\"https://github.com/GoogleChrome/lighthouse/blob/72f1bd47cbb6fcc95349fc936b3fb0f098a93c47/lighthouse-core/config/constants.js#L22-L50\">Ligthouse のリポジトリ内で定義されています</a>。</p>\n<p>これらのエミュレートする値は throttling オブジェクトで与える事ができるので、リポジトリ内の数字を参考に渡してあげることで、やっと Chrome 内蔵の Lighthouse と同じような挙動が可能になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--settings.emulatedFormFactor</span><span class=\"token operator\">=</span>desktop <span class=\"token parameter variable\">--settings.throttling.cpuSlowdownMultiplier</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token parameter variable\">--settings.throttling.throughputKbps</span><span class=\"token operator\">=</span><span class=\"token number\">10240</span> <span class=\"token parameter variable\">--settings.throttling.rttMs</span><span class=\"token operator\">=</span><span class=\"token number\">40</span> <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js</code></pre></div>\n<p>定期的に動かす環境ではスコアを変動させる要因は少なくしたほうがよいので、今後のアップデートで値が変更される可能性も考えると Mobile の場合も固定値で指定したほうがよいかもしれません。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--settings.emulatedFormFactor</span><span class=\"token operator\">=</span>mobile <span class=\"token parameter variable\">--settings.throttling.cpuSlowdownMultiplier</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token parameter variable\">--settings.throttling.throughputKbps</span><span class=\"token operator\">=</span><span class=\"token number\">1638.4</span> <span class=\"token parameter variable\">--settings.throttling.rttMs</span><span class=\"token operator\">=</span><span class=\"token number\">150</span> <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js</code></pre></div>\n<p>ここまでで計測するコマンドを作ることができるようになりました。次はこの結果を Server にアップロードしてみましょう。</p>\n<h3 id=\"upload\" style=\"position:relative;\"><a href=\"#upload\" aria-label=\"upload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>upload</h3>\n<p>upload ステップでやっている事は <code class=\"language-text\">.lighthouse/</code> の内容を参照してターゲットとなる Server にアップロードするだけです。\n言葉にすると非常にシンプルですが、時間をトリガーにしてスコアの定点観測を行うためには少し工夫が必要になります。</p>\n<p>Lighthouse CI が想定しているのは GitHub のコミットに紐づけて、そのコミットによってスコアが変化したかどうかを CI でテストするという使い方です。\nなので、Server に登録する際にはコミットハッシュなどの情報が必要になります。これらの情報は<a href=\"https://github.com/GoogleChrome/lighthouse-ci/issues/5#issuecomment-591578507\">環境変数からコマンドに渡すことができる</a>ので、uplaod コマンドを実行する際に渡してあげます。</p>\n<p>もし環境変数を与えないまま単純に手元で実行しようとするとエラーがおきると思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lhci upload <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js <span class=\"token parameter variable\">--token</span><span class=\"token operator\">=</span>xxxxxxxxxxxxxxxxxx\nError: Unable to determine current <span class=\"token builtin class-name\">hash</span> with <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">git</span> rev-parse HEAD<span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">.</span> This can be overridden with setting LHCI_BUILD_CONTEXT__CURRENT_HASH env.\n    at getCurrentHash <span class=\"token punctuation\">(</span>/usr/local/lib/node_modules/@lhci/cli/node_modules/@lhci/utils/src/build-context.js:74:11<span class=\"token punctuation\">)</span></code></pre></div>\n<p>upload コマンドを実行するために、まずは先程の lighthouserc.js に upload 用の設定を加えます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> puppeteer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'puppeteer'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">ci</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">collect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">chromePath</span><span class=\"token operator\">:</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">executablePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">numberOfRuns</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">upload</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token string\">'lhci'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">serverBaseUrl</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:3000'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>自分は次のようなシェルスクリプトを作って利用しています。<a href=\"https://github.com/GoogleChrome/lighthouse-ci/issues/5#issuecomment-591578507\">こちらの issue</a> に記載されている方法をほぼ踏襲しながら、CURRENT_HASH や COMMIT_TIME の生成のコードを Node.js によせて少し書きかえています。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span><span class=\"token string\">\"Asia/Tokeyo\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__CURRENT_HASH</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>node <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"console.log(crypto.createHash('md5').update(Date.now().toString()).digest('hex'))\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__COMMIT_TIME</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>node <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"console.log(new Date().toISOString())\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__CURRENT_BRANCH</span><span class=\"token operator\">=</span>master\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__COMMIT_MESSAGE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Periodic run $(node -e \"console.log(new Date().toISOString())\"</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"\nexport LHCI_BUILD_CONTEXT__AUTHOR=\"</span>kohta ito <span class=\"token operator\">&lt;</span>koh110@example.com<span class=\"token operator\">></span><span class=\"token string\">\"\nexport LHCI_BUILD_CONTEXT__AVATAR_URL=\"</span>https://avatars2.githubusercontent.com/u/1889831\"\nlhci upload <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js <span class=\"token parameter variable\">--token</span><span class=\"token operator\">=</span>xxxxxx</code></pre></div>\n<p>シェルスクリプトを実行すると 5 個のデータがアップロードされていることがわかります。これは先程 <code class=\"language-text\">numberOfRuns</code> で指定した値分生成されたデータが全て登録されているということです。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">bash</span> <span class=\"token parameter variable\">-x</span> upload.sh\n\n<span class=\"token punctuation\">..</span>.\n\nSaving CI project kohsweb <span class=\"token punctuation\">(</span>e498177b-0226-4de2-afd7-f3bac71afce4<span class=\"token punctuation\">)</span>\nSaving CI build <span class=\"token punctuation\">(</span>db6f110e-e970-4559-b106-5c52fbdcc445<span class=\"token punctuation\">)</span>\nSaved LHR to http://localhost:3000 <span class=\"token punctuation\">(</span>cbd52b66-1725-4383-8532-4d4416392616<span class=\"token punctuation\">)</span>\nSaved LHR to http://localhost:3000 <span class=\"token punctuation\">(</span>e2667737-53d7-4310-8b76-c9d95ca8192f<span class=\"token punctuation\">)</span>\nSaved LHR to http://localhost:3000 <span class=\"token punctuation\">(</span>eea8c09a-a675-44c7-9263-f53bc625e4f3<span class=\"token punctuation\">)</span>\nSaved LHR to http://localhost:3000 <span class=\"token punctuation\">(</span>d24c99d0-ee6e-4e6a-93b5-84c8a2efea91<span class=\"token punctuation\">)</span>\nSaved LHR to http://localhost:3000 <span class=\"token punctuation\">(</span>39d3361d-0aad-4427-820c-463de43ebbea<span class=\"token punctuation\">)</span>\nDone saving build results to Lighthouse CI\nView build <span class=\"token function\">diff</span> at http://localhost:3000/app/projects/kohsweb/compare/db6f110e-e970-4559-b106-5c52fbdcc445\nNo GitHub token set, skipping GitHub status check.</code></pre></div>\n<p>実際に登録されたデータは次のスクリーンショットのように時系列のグラフで表示されます。（これはデータ量が少ないので見栄えが悪いですが……）</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f51989154c156d3e401b4f089bced343/e5166/lighthouse-ci-server-3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3lAH/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFhAAAwAAAAAAAAAAAAAAAAAAAREg/9oACAEBAAE/IQ6//9oADAMBAAIAAwAAABDwz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAICAwAAAAAAAAAAAAAAAAABEBEhMXH/2gAIAQEAAT8QRNuzPIRYz//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse CI\"\n        title=\"Lighthouse CI\"\n        src=\"/static/f51989154c156d3e401b4f089bced343/1c72d/lighthouse-ci-server-3.jpg\"\n        srcset=\"/static/f51989154c156d3e401b4f089bced343/a80bd/lighthouse-ci-server-3.jpg 148w,\n/static/f51989154c156d3e401b4f089bced343/1c91a/lighthouse-ci-server-3.jpg 295w,\n/static/f51989154c156d3e401b4f089bced343/1c72d/lighthouse-ci-server-3.jpg 590w,\n/static/f51989154c156d3e401b4f089bced343/a8a14/lighthouse-ci-server-3.jpg 885w,\n/static/f51989154c156d3e401b4f089bced343/fbd2c/lighthouse-ci-server-3.jpg 1180w,\n/static/f51989154c156d3e401b4f089bced343/e5166/lighthouse-ci-server-3.jpg 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">{{project name}} Builds</code> の列がそれぞれ個別の結果のリンクになっています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/65517306ff67e9e1e4c79617cc7f3a2b/e5166/lighthouse-ci-server-4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3pQB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAExEIH/2gAIAQEAAT8hcEjg5v8A/9oADAMBAAIAAwAAABBTz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAAEEAwEAAAAAAAAAAAAAAAEAESFREDFxkf/aAAgBAQABPxCiOJgk76op4gdiaAax/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lighthouse CI\"\n        title=\"Lighthouse CI\"\n        src=\"/static/65517306ff67e9e1e4c79617cc7f3a2b/1c72d/lighthouse-ci-server-4.jpg\"\n        srcset=\"/static/65517306ff67e9e1e4c79617cc7f3a2b/a80bd/lighthouse-ci-server-4.jpg 148w,\n/static/65517306ff67e9e1e4c79617cc7f3a2b/1c91a/lighthouse-ci-server-4.jpg 295w,\n/static/65517306ff67e9e1e4c79617cc7f3a2b/1c72d/lighthouse-ci-server-4.jpg 590w,\n/static/65517306ff67e9e1e4c79617cc7f3a2b/a8a14/lighthouse-ci-server-4.jpg 885w,\n/static/65517306ff67e9e1e4c79617cc7f3a2b/fbd2c/lighthouse-ci-server-4.jpg 1180w,\n/static/65517306ff67e9e1e4c79617cc7f3a2b/e5166/lighthouse-ci-server-4.jpg 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>個別ページでは他のコミットハッシュからどれだけスコアの変動があったかを詳しく見ることができます。</p>\n<p>また、右上にある <code class=\"language-text\">COMPARE</code> を hover すると <code class=\"language-text\">Open Report</code> というリンクが出てきます。これをクリックすると、そのコミットのスコア（いつも見慣れている Lighthouse の画面）を見ることもできます。（自分はこの機能をよく使います）</p>\n<h1 id=\"lighthouse-ci-の運用-tips\" style=\"position:relative;\"><a href=\"#lighthouse-ci-%E3%81%AE%E9%81%8B%E7%94%A8-tips\" aria-label=\"lighthouse ci の運用 tips permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lighthouse CI の運用 Tips</h1>\n<p>今までの内容で Lighthouse CI の環境を構築する具体的な方法と、データの登録方法について解説しました。\n最後に実運用するにあたってわかった自分が気をつけている Tips について記載します。</p>\n<h2 id=\"lighthousercjs\" style=\"position:relative;\"><a href=\"#lighthousercjs\" aria-label=\"lighthousercjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>lighthouserc.js</h2>\n<p>色々とやるうちに自分は次のような設定ファイルに落ち着きました。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> puppeteer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'puppeteer'</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">ci</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">collect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">chromePath</span><span class=\"token operator\">:</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">executablePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">maxWaitForLoad</span><span class=\"token operator\">:</span> <span class=\"token number\">180000</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">upload</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token string\">'lhci'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">serverBaseUrl</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">ignoreDuplicateBuildFailure</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>解説時と違い <code class=\"language-text\">numberOfRuns</code> はデフォルト値のままです。増やしてもそんなに問題はないのですが、これは運用コストの問題です。\nupload の箇所でも説明したのですが、5 回実行すると 5 個のデータが生成され登録されます。（実際は紐づく Table 数でもうちょっとレコード数は増えます）\nこれが結構馬鹿にならないデータ量になるのでデフォルトの値に戻しました。</p>\n<p>また、実際に画面に表示されているのは、同じ buildId の中の representative フラグが 1 となっているもののみです。\n他のデータは表示はされないのでゴミデータに近いものになるので、最小限にしたいと思っています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mysql> select id,buildId,representative from runs limit 10;\n+--------------------------------------+--------------------------------------+----------------+\n| id                                   | buildId                              | representative |\n+--------------------------------------+--------------------------------------+----------------+\n| 39d3361d-0aad-4427-820c-463de43ebbea | db6f110e-e970-4559-b106-5c52fbdcc445 |              0 |\n| 4d7f18ec-1b35-4655-a846-35fbdd6706a7 | 480f155c-64ba-4c14-a8ee-275a88772dfc |              1 |\n| 551f4b89-82aa-434f-bab4-db9d93772517 | 7e50d809-03e3-4588-b2a2-16924c55c0cd |              0 |\n| 68c429ff-b1de-491f-8d16-b4fb0394c982 | 3c4813ee-1d23-4b52-8c16-f240366dec4e |              0 |\n| 8f3f9293-cdec-4a03-9d88-521d8488c346 | 480f155c-64ba-4c14-a8ee-275a88772dfc |              0 |\n| 9fd30cef-77b0-4dfa-b4fd-58a3a729faed | aea732c5-11e8-4755-8a8a-48cd9d869d17 |              1 |\n| b72cad60-6b8c-4e6f-885c-b8292d6658ee | 3c4813ee-1d23-4b52-8c16-f240366dec4e |              0 |\n| bc6da55f-22ec-4fda-975e-d29c5194baa6 | 480f155c-64ba-4c14-a8ee-275a88772dfc |              0 |\n| cbd52b66-1725-4383-8532-4d4416392616 | db6f110e-e970-4559-b106-5c52fbdcc445 |              0 |\n| cecc001d-661f-4159-a0a4-f4c9f9f09104 | 3c4813ee-1d23-4b52-8c16-f240366dec4e |              1 |\n+--------------------------------------+--------------------------------------+----------------+</code></pre></div>\n<p>upload の設定項目にある <code class=\"language-text\">ignoreDuplicateBuildFailure</code> は入れなくても問題ないのですが、検証時に同じ HASH でアップロードしようとするとエラーになったりするので、検証時の挙動を楽にするために入れています。</p>\n<h2 id=\"定期的な実行\" style=\"position:relative;\"><a href=\"#%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AA%E5%AE%9F%E8%A1%8C\" aria-label=\"定期的な実行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>定期的な実行</h2>\n<p>これは cron による実行で問題ありません。次のようなコードを cron などで定期実行する事で Lighthouse のスコアを定期的に取得しています。</p>\n<p>ここでの Tips は <code class=\"language-text\">--addictive</code> オプションと mobile を測定する時に <code class=\"language-text\">?mobile</code> というクエリパラメータを付与している点です。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">lhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev <span class=\"token parameter variable\">--settings.emulatedFormFactor</span><span class=\"token operator\">=</span>desktop <span class=\"token parameter variable\">--settings.throttling.cpuSlowdownMultiplier</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token parameter variable\">--settings.throttling.throughputKbps</span><span class=\"token operator\">=</span><span class=\"token number\">10240</span> <span class=\"token parameter variable\">--settings.throttling.rttMs</span><span class=\"token operator\">=</span><span class=\"token number\">40</span> <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>/path/to/lighthouserc.js\n\nlhci collect <span class=\"token parameter variable\">--url</span><span class=\"token operator\">=</span>https://blog.koh.dev?mobile <span class=\"token parameter variable\">--settings.emulatedFormFactor</span><span class=\"token operator\">=</span>mobile <span class=\"token parameter variable\">--settings.throttling.cpuSlowdownMultiplier</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token parameter variable\">--settings.throttling.throughputKbps</span><span class=\"token operator\">=</span><span class=\"token number\">1638.4</span> <span class=\"token parameter variable\">--settings.throttling.rttMs</span><span class=\"token operator\">=</span><span class=\"token number\">150</span> <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>/path/to/lighthouserc.js <span class=\"token parameter variable\">--additive</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span><span class=\"token string\">\"Asia/Tokeyo\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__CURRENT_HASH</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>node <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"console.log(crypto.createHash('md5').update(Date.now().toString()).digest('hex'))\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__COMMIT_TIME</span><span class=\"token operator\">=</span><span class=\"token punctuation\">$(</span>node <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"console.log(new Date().toISOString())\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__CURRENT_BRANCH</span><span class=\"token operator\">=</span>master\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LHCI_BUILD_CONTEXT__COMMIT_MESSAGE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Periodic run $(node -e \"console.log(new Date().toISOString())\"</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"\nexport LHCI_BUILD_CONTEXT__AUTHOR=\"</span>kohta ito <span class=\"token operator\">&lt;</span>koh110@example.com<span class=\"token operator\">></span><span class=\"token string\">\"\nexport LHCI_BUILD_CONTEXT__AVATAR_URL=\"</span>https://avatars2.githubusercontent.com/u/1889831\"\nlhci upload <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>./lighthouserc.js <span class=\"token parameter variable\">--token</span><span class=\"token operator\">=</span>xxxxxx</code></pre></div>\n<p><code class=\"language-text\">--addictive</code> は collect コマンドを複数回実行する場合に必要になるオプションです。</p>\n<p>collect コマンドは実行するたびに <code class=\"language-text\">.lighthouse/</code> ディレクトリをクリアします。これは定期実行するにあたってはありがたい機能なのですが、複数の URL をパラメータを変えて計測する場合にはちょっと困ります。\nなので上記の例では <code class=\"language-text\">--addictive</code> で mobile の計測を行う場合に、上書きして消してしまう事を防いでいます。</p>\n<p><code class=\"language-text\">?mobile</code> は URL をユニークにするためのパラメータです。文字列はなんでもかまいません。\nLighthouse CI は URL 単位でデータを扱うため、同じ画面の Desktop/Mobile の両方を計測しようとすると困ります。なので何かしらのクエリパラメータを与えることで別 URL として管理するようにしています。\nまた、mobile という文字列が入っていることで、その結果がどちらの UserAgent で計測したのかの視認性をよくするためにも利用しています。</p>\n<h2 id=\"mysql-容量問題\" style=\"position:relative;\"><a href=\"#mysql-%E5%AE%B9%E9%87%8F%E5%95%8F%E9%A1%8C\" aria-label=\"mysql 容量問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MySQL 容量問題</h2>\n<p>Lighthouse CI はよくできたツールで、実運用にあたってあまり困る部分がありません。唯一困るのは割と富豪的なリソースの使い方をするところです。</p>\n<p>テーブル数は少ないのですが、このうち実行結果を保持する runs が非常に大きな容量を食っていきます。自分が実際に運用している計測環境では 7GB/月の速度でデータ量が増えています。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span>\n+----------------------+\n<span class=\"token operator\">|</span> Tables_in_lighthouse <span class=\"token operator\">|</span>\n+----------------------+\n<span class=\"token operator\">|</span> SequelizeMeta        <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> builds               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> projects             <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> runs                 <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> statistics           <span class=\"token operator\">|</span>\n+----------------------+\n<span class=\"token number\">5</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>レコードの中身を覗いてみるとわかるのですが、計測結果の json が文字列で保存されています。さらに結果に時系列のスクリーンショットデータが base64 エンコードで保存されているため、結構な容量を持っていかれます。</p>\n<p>今のところの自分は次の対処をしています。</p>\n<ul>\n<li>表示に使わないデータを定期的に削除する</li>\n<li>古いデータを定期的に削除する</li>\n</ul>\n<p>uplaod の箇所でも少し触れましたが、表示するデータは representative が 1 となっているデータのみです。なので <code class=\"language-text\">representative = 0</code> となっているデータは今の所必要ありません。これを定期的に削除します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql<span class=\"token operator\">></span> SELECT COUNT<span class=\"token punctuation\">(</span>*<span class=\"token punctuation\">)</span> FROM runs WHERE representative <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nmysql<span class=\"token operator\">></span> DELETE FROM runs WHERE representative <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>もうひとつは Lighthouse CI Server の設定に <code class=\"language-text\">deleteOldBuildsCron</code> を設定を追加して、一定期間以上のデータを削除することです。\nこの設定を追加することで、指定した期間（30 日以上等）のデータを削除する設定です。</p>\n<p>Ref: <a href=\"https://github.com/GoogleChrome/lighthouse-ci/pull/471\">deleteOldBuildsCron</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">deleteOldBuildsCron?: {\n  schedule: string;\n  maxAgeInDays: number;\n}</code></pre></div>\n<p>自分が実運用上データ容量で困っていたので issue で相談したところ、こういう機能はどうかと返答をもらったので PR を送ったところ取り入れてもらえました。</p>\n<h1 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h1>\n<p>Lighthouse CI についてコミットベースではなく定期実行でスコアを計測する方法と運用上の Tips をまとめました。</p>\n<p>Web のパフォーマンスアップをするためにはともあれまず計測をして、現在地点を知らないといけません。Ligthouse CI で自分たちのサイトのパフォーマンスを知ってスコアの改善につなげていきましょう！</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#core-web-vitals-%E3%81%A8%E3%81%AF\">Core Web Vitals とは</a></p>\n</li>\n<li>\n<p><a href=\"#core-web-vitals-%E3%81%AE%E8%A8%88%E6%B8%AC\">Core Web Vitals の計測</a></p>\n<ul>\n<li><a href=\"#crux-searchconsole\">CrUX, SearchConsole</a></li>\n<li><a href=\"#pagespeed-insights-lighthouse\">PageSpeed Insights, Lighthouse</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#lighthouse-ci-%E3%81%AE%E6%A7%8B%E7%AF%89\">Lighthouse CI の構築</a></p>\n<ul>\n<li>\n<p><a href=\"#lighthouse-ci-server-%E3%81%AE%E6%A7%8B%E7%AF%89\">Lighthouse CI Server の構築</a></p>\n</li>\n<li>\n<p><a href=\"#lighthouse-ci\">Lighthouse CI</a></p>\n<ul>\n<li><a href=\"#collect\">collect</a></li>\n<li><a href=\"#upload\">upload</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#lighthouse-ci-%E3%81%AE%E9%81%8B%E7%94%A8-tips\">Lighthouse CI の運用 Tips</a></p>\n<ul>\n<li><a href=\"#lighthousercjs\">lighthouserc.js</a></li>\n<li><a href=\"#%E5%AE%9A%E6%9C%9F%E7%9A%84%E3%81%AA%E5%AE%9F%E8%A1%8C\">定期的な実行</a></li>\n<li><a href=\"#mysql-%E5%AE%B9%E9%87%8F%E5%95%8F%E9%A1%8C\">MySQL 容量問題</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></p>\n</li>\n</ul>","frontmatter":{"title":"Lighthouse CIでサイトのスコアを定期的にチェックしよう","date":"2020-10-24"}}},"pageContext":{"slug":"/2020-10-24-lighthouse-ci/","previous":{"fields":{"slug":"/2020-05-13-async-iterator/"},"frontmatter":{"title":"AsyncIteratorと落とし穴"}},"next":{"fields":{"slug":"/2022-07-02-jest-speedup/"},"frontmatter":{"title":"jestでDBありのテストを高速化する"}}}},"staticQueryHashes":["1366176228","3128451518"],"slicesMap":{}}