{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-01-01-vpn/","result":{"data":{"site":{"siteMetadata":{"title":"kohsweblog","author":"koh110"}},"markdownRemark":{"id":"a310bc0a-0e8e-50bd-9562-cc11f4983ead","excerpt":"まえおき 自分は普段 MacBook Pro の 13 インチを開発機として利用しています。メモリは 16GB にしているので Web…","html":"<h1 id=\"まえおき\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%88%E3%81%8A%E3%81%8D\" aria-label=\"まえおき permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まえおき</h1>\n<p>自分は普段 MacBook Pro の 13 インチを開発機として利用しています。メモリは 16GB にしているので Web 開発をする時にはあまり不便に感じることはありません。\nただ、サービスの開発のステージ環境や、自宅内の自動化や副業で受けている調査案件などはそれぞれ環境ごとに仮想サーバを立ち上げています。</p>\n<p>仮想サーバは nuc に入れた Windows 上の Hyper-V で運用しています。nuc は 24 時間立ち上げたままでテレビにつないで Amazon プライムの再生機も兼ねています。\nメモリも 32GB 積んであるので開発サーバが立ち上がってても通常使用するぶんには割と余裕があります。</p>\n<p>この自宅環境は割と便利で、自宅で開発しているときは十分活躍してくれるのですが、外出中にも開発サーバに ssh で入りたくなることがちょくちょくあります。（あーあのサーバにコード書き捨てたままだったとか、自動化コードが死んだ通知が外出中にきたりとか）</p>\n<p>この問題を解消するために自宅に VPN を導入しようと以前から考えていたのですが、ソフトウェアの利用方法も自分にとっては難しく実現していませんでした。\nそんな折たまたま <a href=\"https://www.wireguard.com/\">WireGuard</a> という文字列を目にして、調べてみたらシンプルで高速な VPN だということがわかりました。</p>\n<p>参考: <a href=\"https://speakerdeck.com/fadis/zuo-tuteli-jie-suruwireguard?slide=2\">https://speakerdeck.com/fadis/zuo-tuteli-jie-suruwireguard?slide=2</a></p>\n<p>さらに調べていくと、かなり設定もシンプルで自分でも理解できそうだったので、家に転がっていた Raspberry Pi を再利用して環境を構築してみることにしました。</p>\n<p>Hyper-V にたてないで Raspberry Pi で構築した理由は、Windows が落ちたときに VPN が落ちてしまうと外から何もできなくなってしまうので、物理的に分割したかったからです。</p>\n<h1 id=\"wireguard-のインストール\" style=\"position:relative;\"><a href=\"#wireguard-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"wireguard のインストール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WireGuard のインストール</h1>\n<p>Raspberry Pi の OS は情報が多そうだったので無難に Raspbian を選択しました。</p>\n<p>各種 OS のインストール方法は公式サイトに詳しくのっているのですが、Raspbian は Debian 系にまとめられているようでした。</p>\n<p><a href=\"https://www.wireguard.com/install/\">https://www.wireguard.com/install/</a></p>\n<p>他に参考にできるドキュメントを探していたら下記のリポジトリに永続化も含めて詳細に載っていたので、こちらを参考に環境を構築しました。</p>\n<p><a href=\"https://github.com/adrianmihalko/raspberrypiwireguard\">https://github.com/adrianmihalko/raspberrypiwireguard</a></p>\n<p>やっていることは ubuntu のレポを追加してインストールできるようにしているっぽいです。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> upgrade\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> raspberrypi-kernel-headers\n$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb http://deb.debian.org/debian/ unstable main\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> --append /etc/apt/sources.list.d/unstable.list\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> dirmngr\n$ <span class=\"token builtin class-name\">printf</span> <span class=\"token string\">'Package: *<span class=\"token entity\" title=\"\\n\">\\n</span>Pin: release a=unstable<span class=\"token entity\" title=\"\\n\">\\n</span>Pin-Priority: 150<span class=\"token entity\" title=\"\\n\">\\n</span>'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> --append /etc/apt/preferences.d/limit-unstable\n$ <span class=\"token function\">sudo</span> apt-key adv --keyserver   keyserver.ubuntu.com --recv-keys 8B48AD6246925553\n$ <span class=\"token function\">sudo</span> apt-key adv --keyserver   keyserver.ubuntu.com --recv-keys 04EE7237B7D453EC\n$ <span class=\"token function\">sudo</span> apt-key adv --keyserver   keyserver.ubuntu.com --recv-keys 7638D0442B90D010\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> wireguard</code></pre></div>\n<p>/etc/sysctl.conf を vi でいじる。net.ipv4.ip_forward の項目を 1 にする。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Uncomment the next line to enable packet forwarding for IPv4</span>\nnet.ipv4.ip_forward<span class=\"token operator\">=</span><span class=\"token number\">1</span></code></pre></div>\n<h1 id=\"wireguard-の設定\" style=\"position:relative;\"><a href=\"#wireguard-%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"wireguard の設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WireGuard の設定</h1>\n<p>まずは VPN を使って外部ネットワークから Raspberry Pi に ssh できるようにします。それができたら Raspberry Pi を踏み台に他のサーバにも ssh できるようにします。</p>\n<p>WireGuard の設定にサーバとクライアントという概念は出ず Peer to Peer のような仕組みになっています。VPN を接続する Peer 同士で秘密鍵と公開鍵の生成が必要になります。</p>\n<p>便宜上ここから先では Raspberry Pi 上の WireGuard をサーバ、Mac に入れる WireGuard アプリをクライアントと考えて説明します。</p>\n<p>WireGuard がインストールできたら、wg というコマンドが利用できるようになるので、サーバ用の秘密鍵と公開鍵を生成します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">mkdir</span> wgkeys\n$ <span class=\"token builtin class-name\">cd</span> wgkeys\n<span class=\"token comment\"># 秘密鍵の生成</span>\n$ wg genkey <span class=\"token operator\">></span> server_private.key\n<span class=\"token comment\"># 秘密鍵から公開鍵を生成</span>\n$ wg pubkey <span class=\"token operator\">></span> server_public.key <span class=\"token operator\">&lt;</span> server_private.key</code></pre></div>\n<p>Mac 用のアプリは公式のストアにあるので、ここからダウンロードします。</p>\n<p><a href=\"https://apps.apple.com/jp/app/wireguard/id1451685025\">https://apps.apple.com/jp/app/wireguard/id1451685025</a></p>\n<p>アプリを起動したら左下の+ボタンから <code class=\"language-text\">Add Empty Tunnel</code> を選択すると秘密鍵と公開鍵が生成されるので、名前をつけて一旦 save します。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 320px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee3c8e26d4e6c479fbd22e16adfeb546/cb69c/mac.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAcAsgH//xAAZEAADAAMAAAAAAAAAAAAAAAAAAQIREiH/2gAIAQEAAQUCSnGsj4f/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGH/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Bqv/EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABgQAQEBAQEAAAAAAAAAAAAAAAERACEx/9oACAEBAAE/IU0nch5oiK83/9oADAMBAAIAAwAAABCH3//EABcRAQADAAAAAAAAAAAAAAAAAAARYXH/2gAIAQMBAT8Q0i3/xAAXEQADAQAAAAAAAAAAAAAAAAAAEVEB/9oACAECAQE/EFmCQ//EABoQAQADAAMAAAAAAAAAAAAAAAEAITERUWH/2gAIAQEAAT8QPGFWO97NicnjC1kC1k//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mac設定\"\n        title=\"Mac設定\"\n        src=\"/static/ee3c8e26d4e6c479fbd22e16adfeb546/cb69c/mac.jpg\"\n        srcset=\"/static/ee3c8e26d4e6c479fbd22e16adfeb546/a80bd/mac.jpg 148w,\n/static/ee3c8e26d4e6c479fbd22e16adfeb546/1c91a/mac.jpg 295w,\n/static/ee3c8e26d4e6c479fbd22e16adfeb546/cb69c/mac.jpg 320w\"\n        sizes=\"(max-width: 320px) 100vw, 320px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>ここで生成された公開鍵をサーバの方の設定ファイルに書くことになります。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 320px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d0ca5d5829b4d18b69a27c46e449903/cb69c/mac_key.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABywQH/8QAFRABAQAAAAAAAAAAAAAAAAAAABL/2gAIAQEAAQUCpSn/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAACAwAAAAAAAAAAAAAAAAAAARARgf/aAAgBAQABPyGqMx//2gAMAwEAAgADAAAAEPAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRABAAIDAAAAAAAAAAAAAAAAAQAhEXHR/9oACAEBAAE/ECgA7I34is0T/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mac鍵\"\n        title=\"Mac鍵\"\n        src=\"/static/1d0ca5d5829b4d18b69a27c46e449903/cb69c/mac_key.jpg\"\n        srcset=\"/static/1d0ca5d5829b4d18b69a27c46e449903/a80bd/mac_key.jpg 148w,\n/static/1d0ca5d5829b4d18b69a27c46e449903/1c91a/mac_key.jpg 295w,\n/static/1d0ca5d5829b4d18b69a27c46e449903/cb69c/mac_key.jpg 320w\"\n        sizes=\"(max-width: 320px) 100vw, 320px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>サーバの設定ファイルは /etc/wireguard/wg0.conf に配置します。</p>\n<p>Interface に自分自身の設定（ここでは Raspberry Pi）、Peer に接続させる端末の設定（ここでは Mac）を書きます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>Interface<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># VPN の仮想的なネットワークで使うIPアドレスを設定する。今回はわかりやすいように10.0.0.1/24で設定した。</span>\nAddress <span class=\"token operator\">=</span> <span class=\"token number\">10.0</span>.0.1/24\n<span class=\"token comment\"># WireGuard を listen させるポート。ルータのポート開放に使うので適当に変える。</span>\nListenPort <span class=\"token operator\">=</span> <span class=\"token number\">123456</span>\n\n<span class=\"token comment\"># wgコマンドで生成した秘密鍵を文字列で記入する</span>\nPrivateKey <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>server_private.key<span class=\"token operator\">></span>\n<span class=\"token comment\"># replace eth0 with the interface open to the internet (e.g might be wlan0 if wifi)</span>\n<span class=\"token comment\"># 起動時と終了時に動くコマンドがかける。ひとまずnatするための呪文だと思っておく。</span>\nPostUp <span class=\"token operator\">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE\nPostDown <span class=\"token operator\">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE\n\n<span class=\"token punctuation\">[</span>Peer<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># Macで生成した公開鍵を文字列で記入する</span>\nPublicKey <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>client_public.key<span class=\"token operator\">></span>\n<span class=\"token comment\"># わかりやすくするためにクライアントの仮想IPを 10.0.0.2/32 に設定する。サーバへの接続許可IPに追加する。</span>\nAllowedIPs <span class=\"token operator\">=</span> <span class=\"token number\">10.0</span>.0.2/32</code></pre></div>\n<p>Mac 側は Peer の反対側なので逆に設定していく。違いは ListenPort がないことと、Endpoint を設定することです。</p>\n<p>Endpoint を設定することで接続先を探しにいけるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>Interface<span class=\"token punctuation\">]</span>\nPrivateKey <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>client_private.key<span class=\"token operator\">></span>\n<span class=\"token comment\"># クライアントの仮想IP</span>\nAddress <span class=\"token operator\">=</span> <span class=\"token number\">10.0</span>.0.2/24\n\n<span class=\"token punctuation\">[</span>Peer<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># serverの公開鍵を文字列で記入する</span>\nPublicKey <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>server_public.key<span class=\"token operator\">></span>\nAllowedIPs <span class=\"token operator\">=</span> <span class=\"token number\">10.0</span>.0.1/32\n<span class=\"token comment\"># サーバのグローバルIPとListenPortを設定する。こんなグローバルIPはありえないけど各環境に合わせてよみかえる。</span>\nEndpoint <span class=\"token operator\">=</span> <span class=\"token number\">192.168</span>.11.1:123456</code></pre></div>\n<p>ここまで設定が終わったらルーターの設定をいじって、Raspberry Pi の IP と ListenPort に指定したポートをインターネットに公開します。\nWireGuard が利用するのは TCP ではなく UDP なので公開するときはその点も注意が必要です。</p>\n<p>設定し終わったらサーバで WireGuard を起動します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> wg-quick up wg0</code></pre></div>\n<p>サーバが起動できていることを確認したら Mac を携帯でテザリングしてから WireGuard アプリで先程設定した Activate ボタンを押します。</p>\n<p>うちのルーターはヘアピン NAT に対応していないので、同じネットワーク内から自分自身のグローバル IP を解決できないので、必ず Mac を別のネットワークにつなぐ必要がありました。（ここに気づくのに結構時間がかかった）</p>\n<p>うまく接続が成功すると自分で設定した仮想 IP に対して ssh で Raspberry Pi に接続できるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">ssh</span> <span class=\"token number\">10.0</span>.0.1</code></pre></div>\n<h1 id=\"lan-内の他の機器にも-vpn-ごしに接続できるようにする\" style=\"position:relative;\"><a href=\"#lan-%E5%86%85%E3%81%AE%E4%BB%96%E3%81%AE%E6%A9%9F%E5%99%A8%E3%81%AB%E3%82%82-vpn-%E3%81%94%E3%81%97%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\" aria-label=\"lan 内の他の機器にも vpn ごしに接続できるようにする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LAN 内の他の機器にも VPN ごしに接続できるようにする</h1>\n<p>この状態では Raspberry Pi 以外にアクセスできないので、Raspberry Pi を踏み台にして家の LAN 内の機器にアクセスできるようにします。</p>\n<p>これは Raspberry Pi 側の設定で PostUp で iptables の MASQUERADE ルールを追加するとできるようになります。</p>\n<p>PostUp の最後に <code class=\"language-text\">iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE</code> を追加します。PostDown で -D することでお掃除も忘れないようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">PostUp <span class=\"token operator\">=</span> iptables -A FORWARD -i %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -A FORWARD -o %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<span class=\"token punctuation\">;</span> iptables -t nat -A POSTROUTING -s <span class=\"token number\">10.0</span>.0.0/24 -j MASQUERADE\nPostDown <span class=\"token operator\">=</span> iptables -D FORWARD -i %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -D FORWARD -o %i -j ACCEPT<span class=\"token punctuation\">;</span> iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE<span class=\"token punctuation\">;</span> iptables -t nat -D POSTROUTING -s <span class=\"token number\">10.0</span>.0.0/24 -j MASQUERADE</code></pre></div>\n<p>Mac 側では Peer の AllowedIPs に他の機器の IP を追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">AllowedIPs <span class=\"token operator\">=</span> <span class=\"token number\">10.0</span>.0.1/32, <span class=\"token number\">192.168</span>.11.0/24</code></pre></div>\n<p>この設定で Mac から 192.168.11.0/24 のレンジにある機器に到達できるようになります。（もちろん ssh だけでなく Remote Desktop 等もできます）</p>\n<h1 id=\"wireguard-を自動起動させる\" style=\"position:relative;\"><a href=\"#wireguard-%E3%82%92%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95%E3%81%95%E3%81%9B%E3%82%8B\" aria-label=\"wireguard を自動起動させる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WireGuard を自動起動させる</h1>\n<p>このままだと Raspberry Pi が再起動すると WireGuard が自動起動しないので、systemctl で自動起動するようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo systemctl start wg-quick@wg0</code></pre></div>\n<h1 id=\"おわりに\" style=\"position:relative;\"><a href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\" aria-label=\"おわりに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>おわりに</h1>\n<p>これで WireGuard を利用して外部ネットワークから自宅の開発サーバにアクセスできるようになりました。</p>\n<p>家に強力なサーバを用意しておけば、カフェなどでも開発ができるのはなかなかよい体験だなと思っています。</p>\n<p>自宅 VPN は思った以上に Quality of Development に貢献するので、簡単に環境を用意できるようになる WireGuard はおすすめです。</p>\n<p>自宅 VPN を用意して快適な開発ライフを送りましょう！</p>","tableOfContents":"<ul>\n<li><a href=\"/2020-01-01-vpn/#%E3%81%BE%E3%81%88%E3%81%8A%E3%81%8D\">まえおき</a></li>\n<li><a href=\"/2020-01-01-vpn/#wireguard-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">WireGuard のインストール</a></li>\n<li><a href=\"/2020-01-01-vpn/#wireguard-%E3%81%AE%E8%A8%AD%E5%AE%9A\">WireGuard の設定</a></li>\n<li><a href=\"/2020-01-01-vpn/#lan-%E5%86%85%E3%81%AE%E4%BB%96%E3%81%AE%E6%A9%9F%E5%99%A8%E3%81%AB%E3%82%82-vpn-%E3%81%94%E3%81%97%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\">LAN 内の他の機器にも VPN ごしに接続できるようにする</a></li>\n<li><a href=\"/2020-01-01-vpn/#wireguard-%E3%82%92%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95%E3%81%95%E3%81%9B%E3%82%8B\">WireGuard を自動起動させる</a></li>\n<li><a href=\"/2020-01-01-vpn/#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\">おわりに</a></li>\n</ul>","frontmatter":{"title":"WireGuardでVPNごしに自宅サーバ開発できる環境を作った","date":"2020-01-01"}}},"pageContext":{"slug":"/2020-01-01-vpn/","previous":{"fields":{"slug":"/2019-11-22-vscode-zenvim/"},"frontmatter":{"title":"VSCodeにZenVimというVim拡張を作った"}},"next":{"fields":{"slug":"/2020-03-04-nodejs-performance/"},"frontmatter":{"title":"0から始めるNode.jsパフォーマンスチューニング"}}}}}