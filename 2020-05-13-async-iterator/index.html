<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/svg+xml" href="/favicon.jpg">
  <title>AsyncIteratorと落とし穴</title>
  <meta name="description" content="Node.js において Stream の処理というのはなくてはならないものです。しかし Stream の文法は慣れるまでは扱いにくいものです。
しかし、AsyncIterator の登場によって Stream を Promise の文脈で...">
  <meta property="og:title" content="AsyncIteratorと落とし穴">
  <meta property="og:image" content="http://localhost:3000/ogimg/2020-05-13-async-iterator.png">
  <meta property="og:url" content="https://blog.koh.dev">
  <meta name="og:description" content="Node.js において Stream の処理というのはなくてはならないものです。しかし Stream の文法は慣れるまでは扱いにくいものです。
しかし、AsyncIterator の登場によって Stream を Promise の文脈で...">
  <meta property="og:type" content="artcle">
  <meta property="og:site_name" content="kohsweblog">
  <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNBJ1CBWWX"></script>

<link rel="stylesheet" href="/_astro/_post_.c53320ea.css" />
<link rel="stylesheet" href="/_astro/_post_.4accc94d.css" /><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-ZNBJ1CBWWX");
</script><link rel="stylesheet" href="/_astro/MarkdownLayout.astro_astro_type_style_index_0_lang.598eec69.css" /></head>
<body>
  
  
  <main class="astro-5GRSW2HI">
    <header class="astro-5GRSW2HI">
      <h3 class="astro-5GRSW2HI"><a href="/" class="astro-5GRSW2HI">kohsweblog</a></h3>
    </header>
    <h1 class="astro-5GRSW2HI">AsyncIteratorと落とし穴</h1>
    <time class="astro-5GRSW2HI">2020-05-13</time>
    <div class="social astro-5GRSW2HI">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="koh110" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button astro-5GRSW2HI" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加">
        <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" class="astro-5GRSW2HI">
      </a>
    </div>
    <div class="og astro-5GRSW2HI">
      <div class="image astro-5GRSW2HI">
        <img style="max-width:100%" src="http://localhost:3000/ogimg/2020-05-13-async-iterator.png" alt="og image" class="astro-5GRSW2HI">
        
      </div>
    </div>
    
  <article class="astro-XSCT23V3">
  <p>Node.js において Stream の処理というのはなくてはならないものです。しかし Stream の文法は慣れるまでは扱いにくいものです。</p>
<p>しかし、AsyncIterator の登場によって Stream を Promise の文脈で処理することができるようになり、「async/await に取り込み」「包括的エラーハンドリング」などができるようになりました。</p>
<p>２年ほど前に AsyncIterator について記事を書きました。<a href="https://qiita.com/koh110/items/0fba3acbce38916928f1">参考: さよなら Stream</a></p>
<p>以前に書いたときにはまだ Experimental な API だったため気軽に利用することはできませんでしたが、今はもう Stable なので、より色々なシーンで活かせる機会が増えるでしょう。</p>
<p>そこでこの記事では今まで書きにくかった Stream や Events のスマートな扱い方、その落とし穴と回避方法をまとめます。</p>
<h1 id="for-awaitof">for await…of</h1>
<p><code>for await...of</code> は非同期な iterator オブジェクトを反復処理できる構文です。<a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/for-await...of">MDN</a></p>
<p>具体的な例をあげると Stream の <code>data</code> イベントなどを処理するのに向いています。</p>
<p>下記は Stream でファイルを読み取り chunk ごとに処理をするコード例です。Stream は大きなデータを断続的に処理することでメモリを効率よく利用したり、同期コードを細切れに処理することで、途中に別のリクエストなどを受けることができます。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">fs</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'fs'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">stream</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> fs.</span><span style="color: #B392F0">createReadStream</span><span style="color: #E1E4E8">(__filename, { encoding: </span><span style="color: #9ECBFF">'utf8'</span><span style="color: #E1E4E8">, highWaterMark: </span><span style="color: #79B8FF">64</span><span style="color: #E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">stream.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'data'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">chunk</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(chunk)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">stream.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'close'</span><span style="color: #E1E4E8">, () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'end!!'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">stream.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, e)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<p>この時、data イベントのハンドラー内では非同期処理を待ち受けることができません。（async function 自体は書けますが、await で処理を実行している間にも data イベントは発生し続けてしまいます。）</p>
<p>また、Stream を扱う時は error イベントを「必ず」ハンドリングしなければなりません。error イベントのハンドリングを忘れると try-catch で受けることができず、エラーが突き抜けてアプリがクラッシュする可能性があります。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">stream.on('data', (chunk) => {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.log(chunk)</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>  stream.emit('error', new Error('error!!'))</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> // stream.on('error', (e) => {</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> //   console.log('error', e)</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span> // })</span></span></code></pre>
<p>これを AsyncIterator を使い <code>for await...of</code> で書き直すと次のようになります。 ReadableStream は data イベントを AsyncIteraotr として回すことができます。</p>
<p><code>for await...of</code> の中では await で処理を待ち受けて、data イベント自体を待つこともできます。また、<code>main().catch</code> で包括的にエラーハンドリングを行うこともできます。</p>
<p>AsyncItaratro は Stream のメリットを受けながらも async/await のメリットを受けることができる素晴らしい記法です。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">fs</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'fs'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">stream</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> fs.</span><span style="color: #B392F0">createReadStream</span><span style="color: #E1E4E8">(__filename, { encoding: </span><span style="color: #9ECBFF">'utf8'</span><span style="color: #E1E4E8">, highWaterMark: </span><span style="color: #79B8FF">64</span><span style="color: #E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">chunk</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">of</span><span style="color: #E1E4E8"> stream) {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(chunk)</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'end!!'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">error</span><span style="color: #E1E4E8">(e))</span></span></code></pre>
<p>このあたりは <a href="https://qiita.com/koh110/items/0fba3acbce38916928f1">さよなら Stream</a> で詳細に説明しているので、そちらを参照してください。</p>
<h1 id="eventson-eventsonce">Events.on, Events.once</h1>
<p>サードパーティ製のモジュールでも Stream を利用しているモジュールはたくさんあります。例えば Redis に接続するモジュールの <a href="https://www.npmjs.com/package/ioredis">ioredis</a> などはよく目にするのではないでしょうか。</p>
<p>ioredis は get/set などが Promise を返し、async/await 環境下でも利用しやすく人気のモジュールです。</p>
<p>Web アプリを作成する際 DB や KVS などを利用する時はサーバの listen をする前にそれぞれの接続を確立していなければなりません。</p>
<p>例えば Redis の場合には次のようなコードになるでしょう。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">http</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'http'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Redis</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'ioredis'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">redis</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Redis</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">server</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> http.</span><span style="color: #B392F0">createServer</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">redis.</span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'ready'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">try</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">// なにか初期化処理</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">init</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    server.</span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">3000</span><span style="color: #E1E4E8">, () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">      console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'Listening on'</span><span style="color: #E1E4E8">, server.</span><span style="color: #B392F0">address</span><span style="color: #E1E4E8">())</span></span>
<span class="line"><span style="color: #E1E4E8">    })</span></span>
<span class="line"><span style="color: #E1E4E8">  } </span><span style="color: #F97583">catch</span><span style="color: #E1E4E8"> (e) {</span></span>
<span class="line"><span style="color: #E1E4E8">    redis.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, e)</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">redis.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">error</span><span style="color: #E1E4E8">(e)</span></span>
<span class="line"><span style="color: #E1E4E8">  process.</span><span style="color: #B392F0">exit</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<p>ioredis は接続が完了した時に <code>connect</code>イベントを emit し、利用可能状態になった時に <code>ready</code> イベントを emit します。つまりアプリケーションが Redis を利用可能になるには、ioredis が <code>ready</code> イベントを発行した時です。</p>
<p>ioredis は Stream を継承したオブジェクトになりますが、ready などは独自に設定されたイベントです。できればこれも AsyncIterator を使って async/await の構文で処理をしたくなります。</p>
<p>独自のイベントを AsyncIterator (Promise) で処理したい時に役に立つのが <a href="https://nodejs.org/api/events.html#events_events_on_emitter_eventname">events.on</a>, <a href="https://nodejs.org/api/events.html#events_events_once_emitter_name">events.once</a>です。</p>
<h2 id="eventson">events.on</h2>
<p>下記は Node.js ドキュメントのサンプルコードに sleep 処理を加えたものです。独自に定義した <code>foo</code> というイベントに対して AsyncIterator で処理することができるようになっているのがわかるかと思います。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">on</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">EventEmitter</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">sleep</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">ms</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">resolve</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(resolve, ms))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">ee</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  process.</span><span style="color: #B392F0">nextTick</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    ee.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'foo'</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">'bar'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    ee.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'foo'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">42</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">event</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">of</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(ee, </span><span style="color: #9ECBFF">'foo'</span><span style="color: #E1E4E8">)) {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(event)</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">sleep</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">(console.error)</span></span></code></pre>
<p>Stream は EventEmitter を継承したオブジェクトなので、この関数を利用することで、独自のイベントを AsyncIterator や Promise で処理することができるようになります。</p>
<h2 id="eventsonce">events.once</h2>
<p>先程の Redis の例を <code>events.once</code> を利用して書き直してみましょう。 <code>events.once</code> は Promise を返却するので await で待ち受けることができるようになります。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">once</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">http</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'http'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Redis</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'ioredis'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">redis</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Redis</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">server</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> http.</span><span style="color: #B392F0">createServer</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">redis.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">error</span><span style="color: #E1E4E8">(e)</span></span>
<span class="line"><span style="color: #E1E4E8">  process.</span><span style="color: #B392F0">exit</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(redis, </span><span style="color: #9ECBFF">'ready'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">init</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  server.</span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">3000</span><span style="color: #E1E4E8">, () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'Listening on'</span><span style="color: #E1E4E8">, server.</span><span style="color: #B392F0">address</span><span style="color: #E1E4E8">())</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">(console.error)</span></span></code></pre>
<p>async/await で処理ができるようになったので、初期化処理などと同等に書くことができるようになったので、見通しがよくなりました。</p>
<p>上のコードみて、なぜ <code>redis.on('error', ...)</code> で catch しているのか疑問に思う人がいるかもしれません。少しずつ解説していきます。</p>
<h2 id="once-に潜む落とし穴--タイミング">once に潜む落とし穴 -タイミング-</h2>
<p>上記の例では once で待ち受ける例がひとつの Stream しかありません。これが 2 つのストリームになるとどうでしょうか。</p>
<p>下記は e1 と e2 を 2 つの Stream に見立てたコードです。e1 が 1 秒後に返す<code>myevent1</code> と e2 が 2 秒後に返す <code>myevent2</code> を待ち受けて done を出力します。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">once</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">EventEmitter</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">2000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e1, </span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e2, </span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'done'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch'</span><span style="color: #E1E4E8">, e))</span></span></code></pre>
<p>実行してみると問題なく動作していることがわかります。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">node</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">async-iterator.js</span></span>
<span class="line"><span style="color: #B392F0">e1</span></span>
<span class="line"><span style="color: #B392F0">e2</span></span>
<span class="line"><span style="color: #F97583">done</span></span></code></pre>
<p>では e1 と e2 の時間を入れ替えてみたらどうなるでしょうか。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">const { once, EventEmitter } = require('events')</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">const main = async () => {</span></span>
<span class="line"><span style="color: #E1E4E8">  const e1 = new EventEmitter()</span></span>
<span class="line"><span style="color: #E1E4E8">  const e2 = new EventEmitter()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  setTimeout(() => {</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.emit('myevent1', 1)</span></span>
<span class="line"><span style="color: #FDAEB7"><span style="user-select: none;">-</span>  }, 1000)</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>  }, 2000)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  setTimeout(() => {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.emit('myevent2', 2)</span></span>
<span class="line"><span style="color: #FDAEB7"><span style="user-select: none;">-</span>  }, 2000)</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>  }, 1000)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  await once(e1, 'myevent1')</span></span>
<span class="line"><span style="color: #E1E4E8">  console.log('e1')</span></span>
<span class="line"><span style="color: #E1E4E8">  await once(e2, 'myevent2')</span></span>
<span class="line"><span style="color: #E1E4E8">  console.log('e2')</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">main()</span></span>
<span class="line"><span style="color: #E1E4E8">  .then(() => console.log("done"))</span></span>
<span class="line"><span style="color: #E1E4E8">  .catch((e) => console.log("catch", e))</span></span></code></pre>
<p>e1 しか出力されませんでした。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">node</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">async-iterator.js</span></span>
<span class="line"><span style="color: #B392F0">e1</span></span></code></pre>
<p>これは <code>once(e2, 'myevent2')</code> でハンドラーをセットする前に e2 は ‘myevent2’ を発行し終えてしまっているので、後続の処理が動かないためです。</p>
<p>つまり、両方の Stream を待ち受けるためには、ハンドラーへのセットを最速で行わなければなりません。events.once は Promise を返すので、同時にハンドラを登録するために Promise.all を利用します。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">once</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">EventEmitter</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">2000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">all</span><span style="color: #E1E4E8">([</span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e1, </span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">), </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e2, </span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">)])</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1 and e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'done'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch'</span><span style="color: #E1E4E8">, e))</span></span></code></pre>
<p>きちんと実行されることが確認できます。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">node</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">async-iterator.js</span></span>
<span class="line"><span style="color: #B392F0">e2</span></span>
<span class="line"><span style="color: #B392F0">e1</span></span>
<span class="line"><span style="color: #B392F0">e1</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">and</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">e2</span></span>
<span class="line"><span style="color: #F97583">done</span></span></code></pre>
<h2 id="once-に潜む落とし穴--エラーハンドリング">once に潜む落とし穴 -エラーハンドリング-</h2>
<p>正常に動作する場合は先程までのコードで問題ありません。では Stream が error を emit した場合はどうでしょうか。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">once</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">EventEmitter</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Error</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error e1'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">2000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">all</span><span style="color: #E1E4E8">([</span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e1, </span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">), </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e2, </span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">)])</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1 and e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'done'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch'</span><span style="color: #E1E4E8">, e))</span></span></code></pre>
<p>一見動きそうですね。しかし実はこのコードはエラーをキャッチすることができません。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ node async-iterator.js</span></span>
<span class="line"><span style="color: #e1e4e8">e2</span></span>
<span class="line"><span style="color: #e1e4e8">events.js:287</span></span>
<span class="line"><span style="color: #e1e4e8">      throw er; // Unhandled 'error' event</span></span>
<span class="line"><span style="color: #e1e4e8">      ^</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">Error: error e1</span></span>
<span class="line"><span style="color: #e1e4e8">    at Timeout._onTimeout (/home/async-iterator.js:99:22)</span></span></code></pre>
<p>実行してみるとエラーがキャッチできず突き抜けてしまっています。これはエラーが emit される箇所に起因しています。エラーの emit を独自イベントの前にしてみましょう。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">const { once, EventEmitter } = require('events')</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">const main = async () => {</span></span>
<span class="line"><span style="color: #E1E4E8">  const e1 = new EventEmitter()</span></span>
<span class="line"><span style="color: #E1E4E8">  const e2 = new EventEmitter()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  setTimeout(() => {</span></span>
<span class="line"><span style="color: #85E89D"><span style="user-select: none;">+</span>    e1.emit('error', new Error('error e1'))</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.emit('myevent1', 1)</span></span>
<span class="line"><span style="color: #FDAEB7"><span style="user-select: none;">-</span>    e1.emit('error', new Error('error e1'))</span></span>
<span class="line"><span style="color: #E1E4E8">    console.log('e1')</span></span>
<span class="line"><span style="color: #E1E4E8">  }, 2000)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  setTimeout(() => {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.emit('myevent2', 2)</span></span>
<span class="line"><span style="color: #E1E4E8">    console.log('e2')</span></span>
<span class="line"><span style="color: #E1E4E8">  }, 1000)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  await Promise.all([once(e1, 'myevent1'), once(e2, 'myevent2')])</span></span>
<span class="line"><span style="color: #E1E4E8">  console.log('e1 and e2')</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">main()</span></span>
<span class="line"><span style="color: #E1E4E8">  .then(() => console.log('done'))</span></span>
<span class="line"><span style="color: #E1E4E8">  .catch((e) => console.log('catch', e))</span></span></code></pre>
<p>こんどは無事にキャッチできていることが確認できます。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">node</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">async-iterator.js</span></span>
<span class="line"><span style="color: #B392F0">e2</span></span>
<span class="line"><span style="color: #B392F0">e1</span></span>
<span class="line"><span style="color: #B392F0">catch</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">Error:</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">error</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">e1</span></span></code></pre>
<p>原理としては単純な話で events.once はワンショットのイベントを受けることを想定している関数です。つまり、最初の <code>myevent1</code> が emit された時点で once でラップした Promise は消化されてしまっています。</p>
<p>最初のサンプルは <code>myevent1</code> が emit された後に error イベントを emit していたため、後続の catch が動かなかったわけです。</p>
<p>しかし Stream はどのイベントがどのタイミングでくるかわかりません。なので error イベントのキャッチは Strem の構文でキャッチしておくのが無難でしょう。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">once</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">EventEmitter</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">require</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'events'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">e2</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EventEmitter</span><span style="color: #E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  e1.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch e1:'</span><span style="color: #E1E4E8">, e)</span></span>
<span class="line"><span style="color: #E1E4E8">    process.</span><span style="color: #B392F0">exit</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  e2.</span><span style="color: #B392F0">on</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, (</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch e2:'</span><span style="color: #E1E4E8">, e)</span></span>
<span class="line"><span style="color: #E1E4E8">    process.</span><span style="color: #B392F0">exit</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    e1.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Error</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'error e1'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">2000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    e2.</span><span style="color: #B392F0">emit</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  }, </span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">all</span><span style="color: #E1E4E8">([</span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e1, </span><span style="color: #9ECBFF">'myevent1'</span><span style="color: #E1E4E8">), </span><span style="color: #B392F0">once</span><span style="color: #E1E4E8">(e2, </span><span style="color: #9ECBFF">'myevent2'</span><span style="color: #E1E4E8">)])</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'e1 and e2'</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">main</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'done'</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  .</span><span style="color: #B392F0">catch</span><span style="color: #E1E4E8">((</span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'catch'</span><span style="color: #E1E4E8">, e))</span></span></code></pre>
<h1 id="まとめ">まとめ</h1>
<p>AsyncIterator の使い方と <code>events.on</code>, <code>events.once</code> を使ってスマートに Stream を扱う方法と、その落とし穴 &#x26; 回避策をまとめました。</p>
</article>

    <hr class="astro-5GRSW2HI">
    <ul class="post-selector astro-5GRSW2HI">
     <li class="astro-5GRSW2HI"><a rel="prev" href="/2020-03-04-nodejs-performance" class="astro-5GRSW2HI"> ← 0から始めるNode.jsパフォーマンスチューニング</a></li>
     <li class="astro-5GRSW2HI"><a rel="next" href="/2020-10-24-lighthouse-ci" class="astro-5GRSW2HI">Lighthouse CIでサイトのスコアを定期的にチェックしよう → </a></li>
    </ul>
    <footer class="astro-SZ7XMLTE">
  © 2023,
  <a href="https://koh.dev" target="_blank" class="astro-SZ7XMLTE">
    kohsweb
  </a>
</footer>
  </main>

  <script src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript" async></script>
</body></html>