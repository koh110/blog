<!DOCTYPE html>
<html lang="ja" class="astro-5GRSW2HI">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/svg+xml" href="/favicon.jpg">
    <meta name="description" content="
# さくら

パケットフィルタに最初は ssh しか設定されていないので http (80,443) を追加する。

これを追加しないといくら ufw や iptables を設定してもインターネット越しの通信が通らない。

```bas">
    <title>さくらで借りたUbuntu16のセットアップ</title>
    <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-40547259-4"></script>

  <script src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript" async></script><link rel="stylesheet" href="/_astro/index.ec7e4e1e.css" />
<link rel="stylesheet" href="/_astro/_post_.f9f0872e.css" /><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","UA-40547259-4");
</script><link rel="stylesheet" href="/_astro/MarkdownLayout.astro_astro_type_style_index_0_lang.afefc3e9.css" /></head>
  
<body class="astro-5GRSW2HI">
  <main class="astro-5GRSW2HI">
    <header class="astro-5GRSW2HI">
      <h3 class="astro-5GRSW2HI"><a href="/" class="astro-5GRSW2HI">kohsweblog</a></h3>
    </header>
    <h1 class="astro-5GRSW2HI">さくらで借りたUbuntu16のセットアップ</h1>
    <time class="astro-5GRSW2HI">2019-07-02</time>
    <div class="social astro-5GRSW2HI">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="koh110" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button astro-5GRSW2HI" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加">
        <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" class="astro-5GRSW2HI">
      </a>
    </div>
    <article class="astro-XSCT23V3">
  <h1 id="さくら">さくら</h1>
<p>パケットフィルタに最初は ssh しか設定されていないので http (80,443) を追加する。</p>
<p>これを追加しないといくら ufw や iptables を設定してもインターネット越しの通信が通らない。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo apt update</span></span></code></pre>
<p><code>/etc/ssh/sshd_config</code> で鍵認証の追加とパスワード認証の disable を行う</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FFA198"><span style="user-select: none;">-</span> #PubkeyAuthentication yes</span></span>
<span class="line"><span style="color: #7EE787"><span style="user-select: none;">+</span> PubkeyAuthentication yes</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FFA198"><span style="user-select: none;">-</span> PasswordAuthentication yes</span></span>
<span class="line"><span style="color: #7EE787"><span style="user-select: none;">+</span> #PasswordAuthentication yes</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FFA198"><span style="user-select: none;">-</span> PermitRootLogin prohibit-password</span></span>
<span class="line"><span style="color: #7EE787"><span style="user-select: none;">+</span> PermitRootLogin no</span></span></code></pre>
<h1 id="nodejs-のインストール">Node.js のインストール</h1>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ wget http://nodejs.org/dist/v12.5.0/node-v12.5.0-linux-x64.tar.gz</span></span>
<span class="line"><span style="color: #C9D1D9">$ tar -C /usr/local --strip-components 1 -xaf node-v12.5.0-linux-x64.tar.gz</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo tar -C /usr/local --strip-components 1 -xaf node-v12.5.0-linux-x64.tar.gz</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo chown -R root:root /usr/local/bin/</span></span></code></pre>
<h1 id="nginx-のインストール">nginx のインストール</h1>
<p>apt 用の GPG key を取得する</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ wget https://nginx.org/keys/nginx_signing.key</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo apt-key add nginx_signing.key</span></span></code></pre>
<p><code>/etc/apt/sources.list</code> を編集して以下の 2 行を追加</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">deb http://nginx.org/packages/ubuntu/ bionic nginx</span></span>
<span class="line"><span style="color: #c9d1d9">deb-src http://nginx.org/packages/ubuntu/ bionic nginx</span></span></code></pre>
<p>更新を反映して nginx をインストール</p>
<p>そのままインストールしようとすると 1.16 をインストールしようとするが、依存パッケージが Ubuntu16 だと追いついていないのでバージョンを指定してインストール</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo apt update</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo apt install nginx=1.10.</span><span style="color: #FF7B72">*</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo systemctl status nginx</span></span></code></pre>
<h1 id="mongodb-のインストール">MongoDB のインストール</h1>
<p>公式にチュートリアルがある</p>
<p><a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/</a></p>
<p>上記ドキュメントが常に正しいと思うが記録のためにコマンドを下記に記す。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/4.0 multiverse"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo apt-get update</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo apt-get install -y mongodb-org</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># DB は apt-get の upgrade で勝手にバージョンアップされると怖いのでバージョンを固定しておく</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"mongodb-org hold"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo dpkg --set-selections</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"mongodb-org-server hold"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo dpkg --set-selections</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"mongodb-org-shell hold"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo dpkg --set-selections</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"mongodb-org-mongos hold"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo dpkg --set-selections</span></span>
<span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"mongodb-org-tools hold"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> sudo dpkg --set-selections</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">$ sudo service mongod start</span></span></code></pre>
<h1 id="redis-のインストール">Redis のインストール</h1>
<p><a href="https://redis.io/download#installation">https://redis.io/download#installation</a></p>
<p>make がなかったのでインストール</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo apt-get install make</span></span></code></pre>
<p>何故か make が失敗する</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ </span><span style="color: #79C0FF">cd</span><span style="color: #C9D1D9"> redis-5.0.5</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo make</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">cd</span><span style="color: #C9D1D9"> src </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> make all</span></span>
<span class="line"><span style="color: #C9D1D9">make[1]: Entering directory </span><span style="color: #A5D6FF">'/tmp/redis-5.0.5/src'</span></span>
<span class="line"><span style="color: #C9D1D9">    CC adlist.o</span></span>
<span class="line"><span style="color: #C9D1D9">/bin/sh: 1: cc: not found</span></span>
<span class="line"><span style="color: #C9D1D9">Makefile:248: recipe </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> target </span><span style="color: #A5D6FF">'adlist.o'</span><span style="color: #C9D1D9"> failed</span></span>
<span class="line"><span style="color: #C9D1D9">make[1]: </span><span style="color: #FF7B72">***</span><span style="color: #C9D1D9"> [adlist.o] Error 127</span></span>
<span class="line"><span style="color: #C9D1D9">make[1]: Leaving directory </span><span style="color: #A5D6FF">'/tmp/redis-5.0.5/src'</span></span>
<span class="line"><span style="color: #C9D1D9">Makefile:6: recipe </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> target </span><span style="color: #A5D6FF">'all'</span><span style="color: #C9D1D9"> failed</span></span>
<span class="line"><span style="color: #C9D1D9">make: </span><span style="color: #FF7B72">***</span><span style="color: #C9D1D9"> [all] Error 2</span></span></code></pre>
<p>そりゃビルドに足りないパッケージあるよな、ということで build-essential をインストール</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo apt-get build-essential</span></span></code></pre>
<p>まだ make に失敗するので、次の issue に従って distclean をしたら動くようになった
<a href="https://github.com/antirez/redis/issues/722">https://github.com/antirez/redis/issues/722</a></p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ make distclean</span></span>
<span class="line"><span style="color: #8B949E"># 動いた</span></span>
<span class="line"><span style="color: #C9D1D9">$ src/redis-server</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># 動いたのでインストール</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo make install</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">$ sudo mkdir -p /var/lib/redis</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo mkdir -p /var/log/redis</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo mkdir -p /etc/redis</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo cp redis.conf /etc/redis</span></span></code></pre>
<p>redis の config を公式サイトを参考に設定する</p>
<p><a href="https://redis.io/topics/config">https://redis.io/topics/config</a></p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">- dir ./</span></span>
<span class="line"><span style="color: #c9d1d9">+ dir /var/lib/redis</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">- logfile ""</span></span>
<span class="line"><span style="color: #c9d1d9">+ logfile /var/log/redis/redis.log</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">- supervised no</span></span>
<span class="line"><span style="color: #c9d1d9">+ supervised systemd</span></span></code></pre>
<p>systemd の設定</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo vim /etc/systemd/system/redis.service</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">[Unit]</span></span>
<span class="line"><span style="color: #c9d1d9">Description=Redis</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">[Service]</span></span>
<span class="line"><span style="color: #c9d1d9">Type=notify</span></span>
<span class="line"><span style="color: #c9d1d9">ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf</span></span>
<span class="line"><span style="color: #c9d1d9">ExecStop=/usr/local/bin/redis-cli -p 6379 shutdown</span></span>
<span class="line"><span style="color: #c9d1d9">User=root</span></span>
<span class="line"><span style="color: #c9d1d9">Group=root</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">[Install]</span></span>
<span class="line"><span style="color: #c9d1d9">WantedBy=multi-user.target</span></span></code></pre>
<p>systemd 設定の反映と start</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">$ sudo systemctl daemon-reload</span></span>
<span class="line"><span style="color: #C9D1D9">$ sudo systemctl start redis</span></span></code></pre>
</article>
    <hr class="astro-5GRSW2HI">
    <ul class="post-selector astro-5GRSW2HI">
     <li class="astro-5GRSW2HI"><a rel="prev" href="/2019-06-11-mongodb-jest" class="astro-5GRSW2HI"> ← MongoDB + Jestのテスト方法</a></li>
     <li class="astro-5GRSW2HI"><a rel="next" href="/2019-08-05-redis-streams" class="astro-5GRSW2HI">Redis Streamsでキューを実装するときの注意点 → </a></li>
    </ul>
    <footer class="astro-5GRSW2HI">
      © 2023, 
      <a href="https://koh.dev" target="_blank" class="astro-5GRSW2HI">
        kohsweb
      </a>
    </footer>
  </main>
</body></html>