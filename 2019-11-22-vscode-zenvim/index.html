<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/svg+xml" href="/favicon.jpg">
  <title>VSCodeにZenVimというVim拡張を作った</title>
  <meta name="description" content="前回の記事 で VSCode/Vim が重くなってしまう件について対処法を調べたが、それでもどうしても重くて厳しかったので自分用に作ってしまった。
作った拡張は ZenVim という名前でマーケットに公開したので、作り方と公開の仕方を備忘録...">
  <meta property="og:title" content="VSCodeにZenVimというVim拡張を作った">
  <meta property="og:image" content="https://blog.koh.dev/ogimg/2019-11-22-vscode-zenvim.png">
  <meta property="og:url" content="https://blog.koh.dev">
  <meta name="og:description" content="前回の記事 で VSCode/Vim が重くなってしまう件について対処法を調べたが、それでもどうしても重くて厳しかったので自分用に作ってしまった。
作った拡張は ZenVim という名前でマーケットに公開したので、作り方と公開の仕方を備忘録...">
  <meta property="og:type" content="artcle">
  <meta property="og:site_name" content="kohsweblog">
  <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNBJ1CBWWX"></script>

<link rel="stylesheet" href="/_astro/_post_.c53320ea.css" />
<link rel="stylesheet" href="/_astro/_post_.4accc94d.css" /><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-ZNBJ1CBWWX");
</script><link rel="stylesheet" href="/_astro/MarkdownLayout.astro_astro_type_style_index_0_lang.598eec69.css" /></head>
<body>
  
  
  <main class="astro-5GRSW2HI">
    <header class="astro-5GRSW2HI">
      <h3 class="astro-5GRSW2HI"><a href="/" class="astro-5GRSW2HI">kohsweblog</a></h3>
    </header>
    <h1 class="astro-5GRSW2HI">VSCodeにZenVimというVim拡張を作った</h1>
    <time class="astro-5GRSW2HI">2019-11-22</time>
    <div class="social astro-5GRSW2HI">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="koh110" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button astro-5GRSW2HI" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加">
        <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" class="astro-5GRSW2HI">
      </a>
    </div>
    <div class="og astro-5GRSW2HI">
      <div class="image astro-5GRSW2HI">
        <img style="max-width:100%" src="/ogimg/2019-11-22-vscode-zenvim.png" alt="og image" class="astro-5GRSW2HI">
        
      </div>
    </div>
    
  <article class="astro-XSCT23V3">
  <p><a href="../2019-10-13-vscode-vim/">前回の記事</a> で <a href="http://aka.ms/vscodevim">VSCode/Vim</a> が重くなってしまう件について対処法を調べたが、それでもどうしても重くて厳しかったので自分用に作ってしまった。</p>
<p>作った拡張は <a href="https://marketplace.visualstudio.com/items?itemName=koh110.zenvim">ZenVim</a> という名前でマーケットに公開したので、作り方と公開の仕方を備忘録にまとめる。</p>
<p><a href="https://github.com/koh110/zenvim/issues">フィードバック募集中です</a></p>
<p>特徴</p>
<ul>
<li>Insert Mode ではほぼ VScode と同じ挙動</li>
<li><code>Ctrl + [</code> で Esc</li>
<li>yank や paste がクリップボードを共有</li>
</ul>
<h1 id="事前調査">事前調査</h1>
<p>前回みつけた <a href="https://github.com/VSCodeVim/Vim/issues/2021">issue</a> の中や Stack Overflow などでは代替手段として <a href="https://marketplace.visualstudio.com/items?itemName=jpotterm.simple-vim">Simple Vim</a> が紹介されていた。</p>
<p>軽快に動くためしばらく利用してみたが、いくつか自分がよく利用するキーバインドが別のキーバインドに割当られていたりした。ex) delete and yank: <code>dd</code> -> <code>rr</code></p>
<p>また Macbook Pro に変えてから Esc が押しづらくなり、Vim の Esc を <code>Ctrl + [</code> に矯正していたのでこれができないのも辛かった。</p>
<p>自分はそこまで Vim のコマンドを多く利用しないのと、Simple Vim コードを眺めていたら for 文回して毎回 Mode 判定している部分など、よりシンプルにできそうな部分があったので練習の意味を含めて fork ではなく自前で実装することにした。</p>
<p>実際に作り始めようとサンプルコードを探していたら Microsoft が公式で VSCode 拡張の<a href="https://github.com/microsoft/vscode-extension-samples">サンプルを公開している</a>のを見つけた。この中に <a href="https://github.com/microsoft/vscode-extension-samples/tree/master/vim-sample">Vim のサンプル</a> もあったので、これを参考にしつつ Visual Mode などを ZenVim として実装した。</p>
<p>余談だが、作るために <a href="https://github.com/VSCodeVim/Vim">https://github.com/VSCodeVim/Vim</a> のコードを読んでみたところ、再現を目指しているせいか高度な抽象化が行われてたり内部に自分でマイクロタスクキューを実装していたりと高度すぎる実装でほとんど参考にならなかった。</p>
<h1 id="hello-world">Hello World</h1>
<p>まずは公式のドキュメントの <a href="https://code.visualstudio.com/api/get-started/your-first-extension">get started</a> を写経から開始した。</p>
<p>Yeoman を使って VSCode 拡張の generator をインストールする。Yeoman 久々にみた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">npm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">install</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-g</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">yo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">generator-code</span></span></code></pre>
<p>TypeScript で作成を始めると VSCode API の型が取れるので、ある程度コードを直接追うことでドキュメントで見つけられないような API を見つけやすかった。デフォルトだと TSLint で Lint をされるのがちょっといけてない。</p>
<p><code>F5</code> を押すとデバッグ開始できると書いてあったが、自分はあまりファンクションキーを使わないので、毎回 Command Palette で <code>Debug: Restart</code> を打ち込んで実行している。</p>
<p>Debug を開始するとまっさらな VSCode の上に書いた拡張を適用した VSCode が立ち上がってくる。</p>
<h1 id="拡張の作り込み">拡張の作り込み</h1>
<p><code>src/extension.ts</code> がエントリポイントなのでそこに内部の実装をしていく。(package.json の main プロパティで変更はできそう)</p>
<p><code>function activate(context: vscode.ExtensionContext)</code> が VSCode が立ち上がったときに呼び出されるときのライフサイクルイベントに対する hook になる。</p>
<h2 id="registercommand">registerCommand</h2>
<p><code>vscode.commands.registerCommand(key, handler)</code> という API で VSCode のイベントに bind できる。</p>
<p><code>registerCommand</code> で返ってくるオブジェクトは activate メソッドの引数に入っている context に必ず push しなければならない。でないとゴミが残るらしい。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">context.subscriptions.</span><span style="color: #B392F0">push</span><span style="color: #E1E4E8">(vscode.commands.</span><span style="color: #B392F0">registerCommand</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'type'</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> { </span><span style="color: #F97583">...</span><span style="color: #E1E4E8"> }))</span></span></code></pre>
<p>これは何度も登場するのでラッピングする関数を定義しておくとよい。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">register</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">key</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">handler</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">...</span><span style="color: #FFAB70">args</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">any</span><span style="color: #E1E4E8">[]) </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  context.subscriptions.</span><span style="color: #B392F0">push</span><span style="color: #E1E4E8">(vscode.commands.</span><span style="color: #B392F0">registerCommand</span><span style="color: #E1E4E8">(key, handler))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">register</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'type'</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> { </span><span style="color: #F97583">...</span><span style="color: #E1E4E8"> })</span></span>
<span class="line"><span style="color: #B392F0">register</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'cut'</span><span style="color: #E1E4E8">, () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> { </span><span style="color: #F97583">...</span><span style="color: #E1E4E8"> })</span></span></code></pre>
<h2 id="入力-event-hook">入力 event hook</h2>
<p><a href="https://github.com/microsoft/vscode-extension-samples/tree/master/vim-sample">公式のサンプル</a>を眺めてみると <code>type</code> というエディタの入力に hook できるイベントがあるので、ここにハンドラを追加するとデフォルトのキー移動を含むキー入力時の挙動を奪える。</p>
<p>Insert Mode のときは <code>executeCommand</code> で <code>default:type</code> を実行すると通常の VSCode の挙動となる。registerCommand のイベントは型定義されていないようなので、この辺のオブジェクトは実行しながら確認しないとならなかった。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">context.subscriptions.</span><span style="color: #B392F0">push</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">  vscode.commands.</span><span style="color: #B392F0">registerCommand</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'type'</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (state.mode </span><span style="color: #F97583">===</span><span style="color: #E1E4E8"> Mode.</span><span style="color: #79B8FF">INSERT</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #6A737D">// 通常のVSCodeの入力処理</span></span>
<span class="line"><span style="color: #E1E4E8">      vscode.commands.</span><span style="color: #B392F0">executeCommand</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'default:type'</span><span style="color: #E1E4E8">, {</span></span>
<span class="line"><span style="color: #E1E4E8">        text: e.text</span></span>
<span class="line"><span style="color: #E1E4E8">      })</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">return</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">try</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #6A737D">// Insert Mode以外のときの挙動</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">type</span><span style="color: #E1E4E8">(vscode.window.activeTextEditor, e.text)</span></span>
<span class="line"><span style="color: #E1E4E8">    } </span><span style="color: #F97583">catch</span><span style="color: #E1E4E8"> (error) {</span></span>
<span class="line"><span style="color: #E1E4E8">      console.</span><span style="color: #B392F0">error</span><span style="color: #E1E4E8">(error)</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"><span style="color: #E1E4E8">)</span></span></code></pre>
<h2 id="ctrl-キーを含む-event-hook">Ctrl キーを含む event hook</h2>
<p><code>type</code> イベントはブラウザと違って Esc や meta キーの入力を取ることができない。</p>
<p>それらのキー入力をhookしたい場合は package.json の contributes で keybindings プロパティを設定する。</p>
<p><a href="https://github.com/koh110/zenvim/blob/master/package.json#L21">https://github.com/koh110/zenvim/blob/master/package.json#L21</a></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">"contributes"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"keybindings"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Escape"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.escapeKey"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:normal"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+["</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.escapeKey"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:normal"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"cmd+c"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.copy"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+c"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.copy"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+e"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.ctrl+e"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:insert"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+f"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.ctrl+f"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:insert"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+b"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.ctrl+b"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:insert"</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"key"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"ctrl+r"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"zenvim.ctrl+r"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #9ECBFF">"when"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"editorTextFocus &#x26;&#x26; !zenvim.mode:insert"</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span></code></pre>
<p>この設定で key と comamnd をバインディングできるので、独自コマンドと key を紐付けていく。この時点ではかぶらないような適当なコマンド名をつける。</p>
<p>when で発火するタイミングを調整できるので、上書きしてほしくない Context を外すように設定しておく。ここでは VSCode がデフォルトで持っている Context と独自に設定できる Context がある（例えば editorTextFocus はエディタ領域にフォーカスがある時というContext）</p>
<p>具体的な Context は<a href="https://code.visualstudio.com/docs/getstarted/keybindings#_contexts">ドキュメントに記載されている</a></p>
<p>独自 Context を設定したいときは executeCommand で setContext を呼び出す。第2引数が追加する Context 名、第3引数が boolean でその Context を有効にするかどうか。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">vscode.commands.</span><span style="color: #B392F0">executeCommand</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">'setContext'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">'zenvim.mode:insert'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">true</span></span>
<span class="line"><span style="color: #E1E4E8">)</span></span></code></pre>
<p>あとは extension.ts に package.json で設定した独自コマンドを vscode.commands.registerCommand で登録して中身を作っていく。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">context.subscriptions.</span><span style="color: #B392F0">push</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">  vscode.commands.</span><span style="color: #B392F0">registerCommand</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'zenvim.escapeKey'</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">e</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">setMode</span><span style="color: #E1E4E8">(Mode.</span><span style="color: #79B8FF">NORMAL</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"><span style="color: #E1E4E8">)</span></span></code></pre>
<h2 id="clipboard">Clipboard</h2>
<p>独自のクリップボード機構を作ってもよかったのだけど、なるべくシンプルに保ちたかったので VSCode の Clipboard API を利用することにした。</p>
<h3 id="copy">copy</h3>
<p>copy は簡単で、選択範囲オブジェクトを getText にわたすとテキストが取得できるので、取れたテキストを vscode.env.clipboard.writeText でクリップボードに書き込む。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">editor</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> vscode.window.activeTextEditor</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 選択されているテキストを取得</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">text</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> editor.document.</span><span style="color: #B392F0">getText</span><span style="color: #E1E4E8">(editor.selection)</span></span>
<span class="line"><span style="color: #6A737D">// clipboard にコピー</span></span>
<span class="line"><span style="color: #E1E4E8">vscode.env.clipboard.</span><span style="color: #B392F0">writeText</span><span style="color: #E1E4E8">(text)</span></span></code></pre>
<h3 id="cut">cut</h3>
<p>cut するときは コピーした内容を削除しなければならないので editor オブジェクトに生えている edit関数の callback に返ってくる editBuilder を利用する。edit関数は非同期で呼び出される。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">editor</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> vscode.window.activeTextEditor</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">await</span><span style="color: #E1E4E8"> editor.</span><span style="color: #B392F0">edit</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">editBuilder</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// copy</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">text</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> editor.document.</span><span style="color: #B392F0">getText</span><span style="color: #E1E4E8">(editor.selection)</span></span>
<span class="line"><span style="color: #E1E4E8">  vscode.env.clipboard.</span><span style="color: #B392F0">writeText</span><span style="color: #E1E4E8">(text)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// delete</span></span>
<span class="line"><span style="color: #E1E4E8">  editBuilder.</span><span style="color: #B392F0">replace</span><span style="color: #E1E4E8">(editor.selection, </span><span style="color: #9ECBFF">''</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<h3 id="paste">paste</h3>
<p>paste は vscode.env.clipboard.readText() で読みだしたテキストをカーソル位置に挿入する。 editorBuilder.insert で場所とテキストを指定すると指定の場所にテキストを挿入できる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">text</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> vscode.env.clipboard.</span><span style="color: #B392F0">readText</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">line</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> editor.selection.active.line</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">character</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> editor.selection.active.character</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">await</span><span style="color: #E1E4E8"> editor.</span><span style="color: #B392F0">edit</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">editBuilder</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  editBuilder.</span><span style="color: #B392F0">insert</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> vscode.</span><span style="color: #B392F0">Position</span><span style="color: #E1E4E8">(line, character), text)</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<h2 id="coursor-jump">Coursor Jump</h2>
<p>意外なことに VSCode の API にはカーソルをジャンプする API がない。（上下左右は cursorMove という API がある）</p>
<p>選択範囲の先頭にカーソルを移動する revealRange という API があるので、幅が0の選択範囲をeditorオブジェクトに反映しそのAPIを呼び出す。</p>
<p>よく使うので関数化しておくと楽。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">jumpCursor</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #FFAB70">editor</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">TextEditor</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #FFAB70">line</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">number</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #FFAB70">charactor</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">number</span></span>
<span class="line"><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (line </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> editor.document.lineCount </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> line) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">anchor</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> vscode.</span><span style="color: #B392F0">Position</span><span style="color: #E1E4E8">(line, charactor)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">active</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> vscode.</span><span style="color: #B392F0">Position</span><span style="color: #E1E4E8">(line, charactor)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// jump</span></span>
<span class="line"><span style="color: #E1E4E8">  editor.selection </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> vscode.</span><span style="color: #B392F0">Selection</span><span style="color: #E1E4E8">(anchor, active)</span></span>
<span class="line"><span style="color: #E1E4E8">  editor.</span><span style="color: #B392F0">revealRange</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> vscode.</span><span style="color: #B392F0">Range</span><span style="color: #E1E4E8">(line, charactor, line, charactor),</span></span>
<span class="line"><span style="color: #E1E4E8">    vscode.TextEditorRevealType.Default</span></span>
<span class="line"><span style="color: #E1E4E8">  )</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<h1 id="マーケットプレイスへ公開">マーケットプレイスへ公開</h1>
<p>公式のドキュメントは<a href="https://code.visualstudio.com/api/working-with-extensions/publishing-extension">ここ</a></p>
<p>npm publish に似た感じで Access Token を使って login 後コマンドから publish する。npm publish と違って token が一定期間で確実に revoke されるので、ここで入手した Token は一生は使えない。</p>
<p>Token につける権限もかなり細かく設定でき、npmに比べて安全になっていてよくできている。</p>
<p>手順を簡単にまとめると下記のようになる。</p>
<ul>
<li><a href="https://azure.microsoft.com/services/devops/">Azure DevOps</a> にアカウントを作成する</li>
<li>拡張機能用のプロジェクトを作成する</li>
<li>Publish するための Token を取得する</li>
<li>npm で vsce コマンドをインストールしてログインする</li>
<li>vsce publish でマーケットプレイスに公開する</li>
</ul>
<h2 id="azure-devops-にアカウントを作成する">Azure DevOps にアカウントを作成する</h2>
<p>特に料金はかからないので Windows のアカウントか GitHub でログインする。</p>
<h2 id="publish-するための-token-を取得する">Publish するための Token を取得する</h2>
<p>名前はなんでもいいが <code>all accessible accounts</code> を選択しないと Token を入力する段階で <code>ERROR  Failed request: (401)</code> となり vsce にログインできないので注意。</p>
<p><a href="https://code.visualstudio.com/api/working-with-extensions/publishing-extension#i-get-403-forbidden-or-401-unauthorized-error-when-i-try-to-publish-my-extension">https://code.visualstudio.com/api/working-with-extensions/publishing-extension#i-get-403-forbidden-or-401-unauthorized-error-when-i-try-to-publish-my-extension</a></p>
<h2 id="token-を取得する">Token を取得する</h2>
<p><a href="https://code.visualstudio.com/api/working-with-extensions/publishing-extension#get-a-personal-access-token">ドキュメント</a>のスクリーンショットは少し古く Security が存在しなかった。</p>
<p>今は Personal Access Token を選択するらしい。</p>
<p><img src="/img/2019-11-22-vscode-zenvim/token.jpeg" alt="アクセストークン"></p>
<p>New Token から適当に名前をつけて権限をつける。今回必要な権限は Marketplace の Acquire と Manage の2つ。</p>
<p>Token は絶対に Expiration をつけなればならないらしく、最長でも半年程度で revoke するらしい。</p>
<h2 id="npm-で-vsce-コマンドをインストールしてログインする">npm で vsce コマンドをインストールしてログインする</h2>
<p>正直グローバルインストールは好きじゃないが、毎回 npx で login もできないのでグローバルにインストールする。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">npm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">install</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-g</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">vsce</span></span></code></pre>
<p>create-publisher コマンドでアカウントを作成する。対話式で名前やメールアドレスを聞かれるので入力する。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">vsce</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">create-publisher</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">{{publisher名}}</span></span></code></pre>
<p>さっき作ったコマンドにログインする。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">vsce</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">login</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">{{publisher名}}</span></span></code></pre>
<p>Azure DevOps で作成した Personal Access Token を publisher に紐付ける。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">vsce</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">publish</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-p</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">{{token}}</span></span></code></pre>
<h2 id="vsce-publish-でマーケットプレイスに公開する">vsce publish でマーケットプレイスに公開する</h2>
<p><code>major</code>, <code>minor</code>, <code>patch</code> のどれかのバージョンを指定して publish コマンをを実行すると該当のバージョンが上がって publish され、ついでに Git のタグが切られる。</p>
<p>このへんは npm とほとんど一緒だが、バージョンアップと公開が同時にされるのが初回はちょっと驚いた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">vsce</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">publish</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">{{major</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">|</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">minor</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">|</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">patch}}</span></span></code></pre>
<h1 id="おわりに">おわりに</h1>
<p>ひさしぶりに新しいプラットフォームにソフトウェアを公開したが、昔に比べて環境が色々と洗練されてきた気がする。</p>
<p>VSCode は API がかなりしっかりしていてドキュメントやサンプルも多く拡張が作りやすかったので、自分にしっくりこない機能はさくっと自作してしまうのがよさそう。</p>
</article>

    <hr class="astro-5GRSW2HI">
    <ul class="post-selector astro-5GRSW2HI">
     <li class="astro-5GRSW2HI"><a rel="prev" href="/2019-10-28-darkmode-css" class="astro-5GRSW2HI"> ← ダークモードを導入してCSS+JSでテーマを管理する</a></li>
     <li class="astro-5GRSW2HI"><a rel="next" href="/2020-01-01-vpn" class="astro-5GRSW2HI">WireGuardでVPNごしに自宅サーバ開発できる環境を作った → </a></li>
    </ul>
    <footer class="astro-SZ7XMLTE">
  © 2023,
  <a href="https://koh.dev" target="_blank" class="astro-SZ7XMLTE">
    kohsweb
  </a>
</footer>
  </main>

  <script src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript" async></script>
</body></html>