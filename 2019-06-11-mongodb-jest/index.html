<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/svg+xml" href="/favicon.jpg">
  <title>MongoDB + Jestのテスト方法</title>
  <meta name="description" content="はじめに
MongoDB のテストを書いて、自分なりの方法が落ち着いたのでまとめる。
結論: mongodb-memory-server を利用する。
本物の MongoDB を使う方法（不採用）
自分は middleware なども含めて...">
  <meta property="og:title" content="MongoDB + Jestのテスト方法">
  <meta property="og:image" content="https://blog.koh.dev/ogimg/2019-06-11-mongodb-jest.png">
  <meta property="og:url" content="https://blog.koh.dev">
  <meta name="og:description" content="はじめに
MongoDB のテストを書いて、自分なりの方法が落ち着いたのでまとめる。
結論: mongodb-memory-server を利用する。
本物の MongoDB を使う方法（不採用）
自分は middleware なども含めて...">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="kohsweblog">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNBJ1CBWWX"></script>

<link rel="stylesheet" href="/_astro/_post_.c53320ea.css" />
<link rel="stylesheet" href="/_astro/_post_.4accc94d.css" /><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-ZNBJ1CBWWX");
</script><link rel="stylesheet" href="/_astro/MarkdownLayout.astro_astro_type_style_index_0_lang.598eec69.css" /></head>
<body>
  
  
  <main class="astro-5GRSW2HI">
    <header class="astro-5GRSW2HI">
      <h3 class="astro-5GRSW2HI"><a href="/" class="astro-5GRSW2HI">kohsweblog</a></h3>
    </header>
    <h1 class="astro-5GRSW2HI">MongoDB + Jestのテスト方法</h1>
    <time class="astro-5GRSW2HI">2019-06-11</time>
    <div class="social astro-5GRSW2HI">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="koh110" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button astro-5GRSW2HI" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加">
        <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" class="astro-5GRSW2HI">
      </a>
    </div>
    <div class="og astro-5GRSW2HI">
      <div class="image astro-5GRSW2HI">
        <img style="max-width:100%" src="/ogimg/2019-06-11-mongodb-jest.png" alt="og image" class="astro-5GRSW2HI">
        
      </div>
    </div>
    
  <article class="astro-XSCT23V3">
  <h2 id="はじめに">はじめに</h2>
<p>MongoDB のテストを書いて、自分なりの方法が落ち着いたのでまとめる。</p>
<p>結論: <a href="https://www.npmjs.com/package/mongodb-memory-server" target="_blank">mongodb-memory-server</a> を利用する。</p>
<h2 id="本物の-mongodb-を使う方法不採用">本物の MongoDB を使う方法（不採用）</h2>
<p>自分は middleware なども含めてテストするために、実環境と同じ環境を用意して単体テスト時もそれらを利用するのが基本方針だった。</p>
<p>そこで MongoDB のテストもテスト用の DB を用意したが、DB を利用したテストでつきまとうテストの ABA 問題（初期化処理が二重に走って後続のテストが失敗する）に引っかかり、解決策を考えていた。</p>
<p>普段は並列数に合わせて <code>CREATE DATABASE</code> して DB 接続部分でそれぞれ被らないようにつなげる、という手法をよくやるのだが、Jest で並列数を固定化する方法にたどり着けなかった。</p>
<p>テスト開始のたびに自動で増やし続けてもいいが、ちょっとコストがかさみすぎるかなということで不採用とした。</p>
<h2 id="jest-公式が提示する方法不採用">Jest 公式が提示する方法（不採用）</h2>
<p><a href="https://jestjs.io/docs/en/mongodb">https://jestjs.io/docs/en/mongodb</a></p>
<p>ちゃんと Jest のドキュメントを読んでいると MongoDB のテストについてちゃんと記載があった。</p>
<p><code>@shelf/jest-mongodb</code> というモジュールを使う方法だったので中身を読んでみた。</p>
<p><a href="https://www.npmjs.com/package/@shelf/jest-mongodb">https://www.npmjs.com/package/@shelf/jest-mongodb</a></p>
<p><a href="https://github.com/shelfio/jest-mongodb">https://github.com/shelfio/jest-mongodb</a></p>
<p>中を見てみると、やっていることは Global Setup 時に mongodb-memory-server を立ち上げて、 Global Teardown 時に掃除しているだけだった。</p>
<p>mongodb-memory-server は人気があり活発に開発されているモジュールで、MongoDB の機能をほぼ網羅している。</p>
<p>jest-mongodb の機能が Setup/Teardown の Utility を提供するだけなのであれば、 mongodb-memory-server を直接使うほうが MongoDB のバージョンアップへの追従やモジュール自体のバグ修正に追いつくことも容易だろうということで、 jest-mongodb は採用しないことにした。</p>
<p>download 数もそこまで多くなく、更新頻度も流石に mongodb-memory-server に追従はできていなそうだったのも要因のひとつ。</p>
<h2 id="mongodb-memory-server採用">mongodb-memory-server（採用）</h2>
<p><code>@shelf/jest-mongodb</code> を参考に Setup/Teardown のスクリプトを自分で用意した。</p>
<p>setup.ts で MongoMemoryServer インスタンスを起動して global に。接続用の URI はアプリケーションが環境変数から読み込む仕様だったので環境変数に。</p>
<p>TypeScript で書いているわけだし本来は global の namespace にきちんと MongoMemoryServer の型を追加するべきなんだろうけど、テストコードでこのインスタンスにふれる事も少ないので any としてしまった。TypeScript は頑張りすぎないように書く方針。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> { MongoMemoryServer } </span><span style="color: #F97583">from</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'mongodb-memory-server'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">default</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">mongoServer</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">MongoMemoryServer</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">mongoUri</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> mongoServer.</span><span style="color: #B392F0">getConnectionString</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  ;(global </span><span style="color: #F97583">as</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">any</span><span style="color: #E1E4E8">).</span><span style="color: #79B8FF">MONGO_MEMORY_SERVER</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> mongoServer</span></span>
<span class="line"><span style="color: #E1E4E8">  process.env.</span><span style="color: #79B8FF">MONGODB_TEST_URI</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> mongoUri</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>最近は ; 省略派なので global への追加部分がちょっと読みづらくなってしまったが、あまり頻繁に手を加える部分じゃないしこのままとした。</p>
<p>teardown.ts は単純に global にある MongoMemoryServer を停止して終了。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">default</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> (global </span><span style="color: #F97583">as</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">any</span><span style="color: #E1E4E8">).</span><span style="color: #79B8FF">MONGO_MEMORY_SERVER</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">stop</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>あとはテストの beforeAll と afterAll で db に接続すればテストができる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">let</span><span style="color: #E1E4E8"> client </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">null</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">beforeAll</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  client </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> MongoClient.</span><span style="color: #B392F0">connect</span><span style="color: #E1E4E8">(process.env.</span><span style="color: #79B8FF">MONGODB_TEST_URI</span><span style="color: #E1E4E8">, {</span></span>
<span class="line"><span style="color: #E1E4E8">    useNewUrlParser: </span><span style="color: #79B8FF">true</span></span>
<span class="line"><span style="color: #E1E4E8">  })</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">afterAll</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> client.</span><span style="color: #B392F0">close</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">test</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'...'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> () </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// test</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre>
<p>メモリ上で動くので高速に動作するし、並列テストも容易。さらに実際の DB を用意する必要がなくなったので CI 上でも実行しやすくなった。</p>
<p>実際の MongoDB で動かすのはパターンを絞って e2e テストなどで対応しようと思う。</p>
<h2 id="まとめ">まとめ</h2>
<p><a href="https://www.npmjs.com/package/mongodb-memory-server" target="_blank">mongodb-memory-server</a> を利用して MongoDB + Jest のテストをできるようにした。</p>
</article>

    <hr class="astro-5GRSW2HI">
    <ul class="post-selector astro-5GRSW2HI">
     <li class="astro-5GRSW2HI"><a rel="prev" href="/2019-06-07-mongodb-typescript" class="astro-5GRSW2HI"> ← MongoDB + Node.js + TypeScriptが強力だった</a></li>
     <li class="astro-5GRSW2HI"><a rel="next" href="/2019-07-02-ubuntu-setup" class="astro-5GRSW2HI">さくらで借りたUbuntu16のセットアップ → </a></li>
    </ul>
    <footer class="astro-SZ7XMLTE">
  © 2023,
  <a href="https://koh.dev" target="_blank" class="astro-SZ7XMLTE">
    kohsweb
  </a>
</footer>
  </main>

  <script src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript" async></script>
</body></html>