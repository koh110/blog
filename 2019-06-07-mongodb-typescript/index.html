<!DOCTYPE html>
<html lang="ja" class="astro-5GRSW2HI">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/svg+xml" href="/favicon.jpg">
    <meta name="description" content="
## はじめに

MongoDB (node-mongodb-native) + Node.js + TypeScript で RDB 並のスキーマ定義と、NoSQL の開発しやすさを両立できたのでまとめます。

## Node.js と">
    <title>MongoDB + Node.js + TypeScriptが強力だった</title>
    <!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZNBJ1CBWWX"></script>

  <script src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript" async></script><link rel="stylesheet" href="/_astro/index.ec7e4e1e.css" />
<link rel="stylesheet" href="/_astro/_post_.f9f0872e.css" /><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-ZNBJ1CBWWX");
</script><link rel="stylesheet" href="/_astro/MarkdownLayout.astro_astro_type_style_index_0_lang.886f84cf.css" /></head>
  
<body class="astro-5GRSW2HI">
  <main class="astro-5GRSW2HI">
    <header class="astro-5GRSW2HI">
      <h3 class="astro-5GRSW2HI"><a href="/" class="astro-5GRSW2HI">kohsweblog</a></h3>
    </header>
    <h1 class="astro-5GRSW2HI">MongoDB + Node.js + TypeScriptが強力だった</h1>
    <time class="astro-5GRSW2HI">2019-06-07</time>
    <div class="social astro-5GRSW2HI">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="koh110" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button astro-5GRSW2HI" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加">
        <img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" class="astro-5GRSW2HI">
      </a>
    </div>
    <article class="astro-XSCT23V3">
  <h2 id="はじめに">はじめに</h2>
<p>MongoDB (node-mongodb-native) + Node.js + TypeScript で RDB 並のスキーマ定義と、NoSQL の開発しやすさを両立できたのでまとめます。</p>
<h2 id="nodejs-と-mongodb">Node.js と MongoDB</h2>
<p>MongoDB はドキュメント指向データベースです。簡単に言えば JSON のような形でデータを保持できる NoSQL です。</p>
<p>MySQL や Postgres などの RDB と違い、事前に CREATE TABLE のようなコマンドを打たなくても、insert されたタイミングで collection が作成され、データが保存されます。</p>
<p>また、MongoDB は後発のデータベースということもあり、RDB では 1 クエリで素直に表すことが難しいクエリも多くがクエリ化されていて 1 トランザクションで実行が可能です。（findOrUpdate など）</p>
<p>この柔軟性は非常に強力で、開発開始までのオーバーヘッドを大きく下げてくれます。</p>
<p>しかし、その柔軟さ故に後から加わった開発者がコードからデータの構造を読み取るのが難しいという難点もあります。</p>
<p>Node.js + MongoDB では <a href="https://mongoosejs.com/" target="_blank">mongoose</a> か <a href="http://mongodb.github.io/node-mongodb-native/" target="_blank">node-mongodb-native</a> が多く利用されます。</p>
<p>今までは上記のデータ構造の問題に対処するため、mongoose を利用してオブジェクトのスキーマ定義などを行ったりしていました。しかし、mongoose は ORM という特性上内部的に Object へのマッピングなど、パフォーマンスに影響を与えてしまうことが少なくありませんでした。そのためパフォーマンスが要求されるような箇所では mongoose から Object への変換が行われないようにするなど工夫されることが多いですが、そうしてしまうことでまたスキーマ定義がなく自由に使えてしまうというトレードオフが発生していました。</p>
<p>パフォーマンスの問題にぶつかることも多く、自分は mongoose はあまり使わなくなり node-mongo-native をメインに使っていました。</p>
<p>ある時、Node.js も TypeScript で全部書いてみようと試してみたところ、node-mongo-native を利用していてもスキーマ定義を TypeScript に任せることができ、データ構造がわかりにくいという問題が解決できてしまいました。</p>
<h2 id="typescript-を組み合わせた-mongodb">TypeScript を組み合わせた MongoDB</h2>
<p>下記が MongoDB アクセス用モジュール <code>db.ts</code> です。１つの School に対して Student が複数所属する設計とします。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { MongoClient, Collection, ObjectId } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'mongodb'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">MONGODB_URI</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'mongodb://[user:password]@localhost:27017/example'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">School</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">_id</span><span style="color: #FF7B72">?:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ObjectId</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Student</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">_id</span><span style="color: #FF7B72">?:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ObjectId</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">schoolId</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ObjectId</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">collections</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">school</span><span style="color: #C9D1D9">: Collection</span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9">School</span><span style="color: #FF7B72">></span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FFA657">student</span><span style="color: #C9D1D9">: Collection</span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9">Student</span><span style="color: #FF7B72">></span></span>
<span class="line"><span style="color: #C9D1D9">} </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  school: </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">  student: </span><span style="color: #79C0FF">null</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">client</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> MongoClient.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">MONGODB_URI</span><span style="color: #C9D1D9">, {</span></span>
<span class="line"><span style="color: #C9D1D9">    useNewUrlParser: </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">db</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> client.</span><span style="color: #D2A8FF">db</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'example'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">  collections.schools </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> db.</span><span style="color: #D2A8FF">collection</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">School</span><span style="color: #C9D1D9">>(</span><span style="color: #A5D6FF">'schools'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">  collections.students </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> db.</span><span style="color: #D2A8FF">collection</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">Student</span><span style="color: #C9D1D9">>(</span><span style="color: #A5D6FF">'students'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>ちなみにサーバー側はこんな感じで DB に接続が完了したら listen を開始するようにします。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> http </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'http'</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> express </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'express'</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> db </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'./db'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">app</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">express</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> http.</span><span style="color: #D2A8FF">createServer</span><span style="color: #C9D1D9">(app)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">().</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">8000</span><span style="color: #C9D1D9">, () </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'Listening on'</span><span style="color: #C9D1D9">, server.</span><span style="color: #D2A8FF">address</span><span style="color: #C9D1D9">())</span></span>
<span class="line"><span style="color: #C9D1D9">  })</span></span>
<span class="line"><span style="color: #C9D1D9">})</span></span></code></pre>
<p>ここで Student にひとつレコードを追加するコードを見てみましょう。</p>
<p><code>db.collections.student</code> は db モジュールの中で型定義がされているので <code>Student</code> 型以外のオブジェクトを insertOne に与えようとすると TypeScript がエラーを返します。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { ObjectId } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'mongodb'</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">*</span><span style="color: #C9D1D9"> db </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'./db'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">addStudent</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">schoolId</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ObjectId</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">student</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    schoolId: schoolId,</span></span>
<span class="line"><span style="color: #C9D1D9">    name: name</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">res</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> db.collections.students.</span><span style="color: #D2A8FF">insertOne</span><span style="color: #C9D1D9">(student)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> res</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>addStudent は引数以外で型定義も行っておらず JavaScript と変わらない書き味であるにもかかわらず、insert するべきオブジェクトが型安全になるというメリットが得られます。もちろんこれらの型は find や update などにも適用されます。</p>
<p>さらにこの組み合わせが強力なのは、交差型を利用することで MongoDB の aggregate（RDB でいう join）も型を使って効率よく開発できることです。</p>
<p>下記のコードは students コレクションから school というパラメータに school コレクションのデータを id をもとに join するサンプルです。</p>
<p><code>.aggregate&#x3C;db.Student &#x26; { school: db.School }></code> がキモのコードで、交差型を使うことで Student 型に School 型の schrool パラメータを追加しています。こうすることで、aggregate の return が any にならず型の補助を受けられます。（lookup に合わせて自分で交差型を適切に書かないといけない部分は若干イケてないと思うがうまい方法を思いついていない。）</p>
<p>本来は toArray せずに cursor にして map を使わない方がきっとパフォーマンスはいいです。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { ObjectId } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'mongodb'</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">*</span><span style="color: #C9D1D9"> db </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'./db'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">getStudent</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">studentId</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ObjectId</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">students</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> db.collections.students</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">aggregate</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">db</span><span style="color: #C9D1D9">.</span><span style="color: #FFA657">Student</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">school</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">db</span><span style="color: #C9D1D9">.</span><span style="color: #FFA657">School</span><span style="color: #C9D1D9"> }>([</span></span>
<span class="line"><span style="color: #C9D1D9">      {</span></span>
<span class="line"><span style="color: #C9D1D9">        $match: { _id: studentId }</span></span>
<span class="line"><span style="color: #C9D1D9">      },</span></span>
<span class="line"><span style="color: #C9D1D9">      {</span></span>
<span class="line"><span style="color: #C9D1D9">        $lookup: {</span></span>
<span class="line"><span style="color: #C9D1D9">          from: </span><span style="color: #A5D6FF">'schools'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">          localField: </span><span style="color: #A5D6FF">'schoolId'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">          foreignField: </span><span style="color: #A5D6FF">'_id'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">          as: </span><span style="color: #A5D6FF">'school'</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">      }</span></span>
<span class="line"><span style="color: #C9D1D9">    ]).</span><span style="color: #D2A8FF">toArray</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> students</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">student</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        _id: student._id,</span></span>
<span class="line"><span style="color: #C9D1D9">        name: student.name,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// schoolId: student.schoolId,</span></span>
<span class="line"><span style="color: #C9D1D9">        school: {</span></span>
<span class="line"><span style="color: #C9D1D9">          _id: student.school._id,</span></span>
<span class="line"><span style="color: #C9D1D9">          name: student.school.name</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">      }</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<h2 id="まとめ">まとめ</h2>
<p>MongoDB (node-mongodb-native) + Node.js + TypeScript の組み合わせを用いることで RDB 並のスキーマ定義と、NoSQL の開発しやすさを両立できました。</p>
</article>
    <hr class="astro-5GRSW2HI">
    <ul class="post-selector astro-5GRSW2HI">
     <li class="astro-5GRSW2HI"><a rel="prev" href="/2019-01-03-chat" class="astro-5GRSW2HI"> ← チャットシステムを作るときに知っておくべきこと</a></li>
     <li class="astro-5GRSW2HI"><a rel="next" href="/2019-06-11-mongodb-jest" class="astro-5GRSW2HI">MongoDB + Jestのテスト方法 → </a></li>
    </ul>
    <footer class="astro-5GRSW2HI">
      © 2023, 
      <a href="https://koh.dev" target="_blank" class="astro-5GRSW2HI">
        kohsweb
      </a>
    </footer>
  </main>
</body></html>